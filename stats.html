<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìä Stats Dashboard | MediaTracker Pro</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --bg: #0b1220;
      --card: #0f1724;
      --ink: #e6eef9;
      --muted: rgba(230,238,249,.7);
      --stroke: rgba(255,255,255,.08);
      --accent: #7c3aed;
      --accent2: #9f7aea;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background-color: var(--bg);
      color: var(--ink);
      font-family: "Inter", system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    header {
      background: var(--card);
      padding: 14px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--stroke);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 { margin: 0; font-size: 18px; }
    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: box-shadow .2s ease, transform .1s ease;
    }
    .btn:hover { box-shadow: 0 0 12px rgba(124,58,237,.6); }
    .btn:active { transform: scale(.98); }

    .wrapper {
      padding: 16px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .profile-section {
      position: relative;
      text-align: center;
      margin-bottom: 24px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      overflow: hidden;
      padding-bottom: 20px;
    }
    .banner {
      position: relative;
      width: 100%;
      height: 220px;
      background: #1a2233 center/cover no-repeat;
    }
    .banner button {
      position: absolute;
      bottom: 10px;
      right: 10px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    .avatar-wrap {
      position: relative;
      width: 130px;
      height: 130px;
      margin: -65px auto 0;
      border-radius: 50%;
      border: 4px solid var(--bg);
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      background: #121826;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .avatar {
      width: 102%;
      height: 102%;
      object-fit: cover;
      display: block;
      background-color: transparent;
      transform: scale(1.02);
    }
    .avatar-btn {
      margin-top: 10px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 13px;
      cursor: pointer;
      transition: box-shadow .2s ease, transform .1s ease;
    }
    .avatar-btn:hover { box-shadow: 0 0 10px rgba(124,58,237,.6); }
    .avatar-btn:active { transform: scale(.97); }

    .display-name {
      margin: 12px 0 6px;
      font-size: 18px;
      font-weight: 700;
    }
    .subtitle {
      color: var(--muted);
      font-size: 13px;
      margin: 0 0 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }
    .card {
      background: rgba(255,255,255,.04);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 16px;
    }
    .card h3 {
      margin: 0;
      font-size: 14px;
      color: var(--muted);
    }
    .card p.n {
      font-size: 28px;
      font-weight: 800;
      margin: 6px 0 0;
    }

    #chartWrap {
      margin: 28px auto 10px;
      max-width: 520px;
      background: rgba(255,255,255,.04);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 16px;
    }

    input[type="file"] { display: none; }

    .toast {
      position: fixed;
      right: 14px;
      bottom: 14px;
      background: #111827;
      color: #e6eef9;
      border: 1px solid var(--stroke);
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      z-index: 9999;
      opacity: 0;
      transform: translateY(6px);
      animation: toast-in .25s ease forwards;
    }
    @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <header>
    <h1>üìä Stats Dashboard</h1>
    <button class="btn" onclick="window.location.href='index.html'">üè† Back to Library</button>
  </header>

  <div class="wrapper">
    <section class="profile-section">
      <div id="banner" class="banner">
        <button id="bannerBtn">üì∑ Add Banner</button>
      </div>

      <div id="avatarWrap" class="avatar-wrap">
        <img id="avatar" class="avatar" alt="" />
      </div>
      <button id="avatarBtn" class="avatar-btn">üì∑ Add Picture</button>

      <h2 id="displayName" class="display-name">Loading‚Ä¶</h2>
      <p class="subtitle">Your profile is editable only by you.</p>
    </section>

    <section class="stats-grid">
      <div class="card"><h3>üé• Total Videos</h3><p id="videoCount" class="n">0</p></div>
      <div class="card"><h3>üñºÔ∏è Total Images</h3><p id="photoCount" class="n">0</p></div>
      <div class="card"><h3>‚è±Ô∏è Total Watch Time</h3><p id="watchTime" class="n">‚Äî</p></div>
    </section>

    <section id="chartWrap" class="card">
      <h3 style="margin-bottom:8px;">Media Mix</h3>
      <canvas id="mediaChart"></canvas>
    </section>

    <input id="bannerInput" type="file" accept="image/*" />
    <input id="avatarInput" type="file" accept="image/*" />
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBH691ymS0uO7JejXC1MGFuhiIElD78UPY",
      authDomain: "personalplayer-c8d3b.firebaseapp.com",
      projectId: "personalplayer-c8d3b",
      storageBucket: "personalplayer-c8d3b.appspot.com",
      messagingSenderId: "396785312809",
      appId: "1:396785312809:web:02290950ec22a13165a838"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    const banner = document.getElementById("banner");
    const avatar = document.getElementById("avatar");
    const bannerBtn = document.getElementById("bannerBtn");
    const avatarBtn = document.getElementById("avatarBtn");
    const bannerInput = document.getElementById("bannerInput");
    const avatarInput = document.getElementById("avatarInput");
    const displayNameEl = document.getElementById("displayName");
    const videoCount = document.getElementById("videoCount");
    const photoCount = document.getElementById("photoCount");
    const watchTime = document.getElementById("watchTime");

    function toast(msg) {
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => { t.style.opacity = "0"; setTimeout(() => t.remove(), 250); }, 2200);
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) return window.location.href = "login.html";
      displayNameEl.textContent = user.displayName || "Unnamed User";
      const uid = user.uid;
      const profileRef = db.collection("userProfile").doc(uid);

      profileRef.onSnapshot((doc) => {
        const d = doc.data() || {};
        if (d.bannerUrl) banner.style.backgroundImage = `url(${d.bannerUrl})`;
        if (d.avatarUrl) avatar.src = d.avatarUrl;
      });

      bannerBtn.onclick = () => bannerInput.click();
      bannerInput.onchange = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try {
          const ref = storage.ref(`profile/banner_${uid}.jpg`);
          await ref.put(file);
          const url = await ref.getDownloadURL();
          await profileRef.set({ bannerUrl: url }, { merge: true });
          banner.style.backgroundImage = `url(${url})`;
          toast("‚úÖ Banner updated");
        } catch (err) { toast("‚ö†Ô∏è Banner upload failed"); }
      };

      avatarBtn.onclick = () => avatarInput.click();
      avatarInput.onchange = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        try {
          const ref = storage.ref(`profile/avatar_${uid}.jpg`);
          await ref.put(file);
          const url = await ref.getDownloadURL();
          await profileRef.set({ avatarUrl: url }, { merge: true });
          avatar.src = url;
          toast("‚úÖ Profile picture updated");
        } catch (err) { toast("‚ö†Ô∏è Avatar upload failed"); }
      };

      db.collection("videos").onSnapshot((snapshot) => {
        let videos = 0, photos = 0, totalDuration = 0;
        snapshot.forEach((doc) => {
          const d = doc.data();
          if (d.type === "video") { videos++; totalDuration += d.duration || 0; }
          else if (d.type === "photo") photos++;
        });
        videoCount.textContent = videos;
        photoCount.textContent = photos;
        watchTime.textContent = totalDuration > 0 ? (totalDuration / 60).toFixed(1) + " min" : "‚Äî";
      });
    });
  </script>
</body>
</html>
