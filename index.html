<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MediaTracker Pro — Animated Login + Full Features</title>
<meta name="theme-color" content="#0b1220" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0b1220; --card:#0f1724; --ink:#e6eef9; --muted:rgba(230,238,249,.7);
    --accent:#7c3aed; --accent2:#9f7aea; --success:#10b981; --danger:#ef4444;
    --stroke:rgba(255,255,255,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);}
  /* Flowing gradient waves background */
  .bg-anim{position:fixed;inset:0;z-index:-1;overflow:hidden;}
  .bg-anim::before,.bg-anim::after{content:"";position:absolute;width:160vmax;height:160vmax;left:50%;top:50%;transform:translate(-50%,-50%);border-radius:50%;filter:blur(70px);opacity:.45;}
  .bg-anim::before{background:radial-gradient(circle at 30% 30%, var(--accent), transparent 60%), radial-gradient(circle at 70% 70%, var(--accent2), transparent 60%);animation:float1 22s ease-in-out infinite alternate;}
  .bg-anim::after{background:radial-gradient(circle at 70% 30%, #0ea5e9, transparent 60%), radial-gradient(circle at 30% 70%, #22d3ee, transparent 60%);mix-blend-mode:screen;animation:float2 26s ease-in-out infinite alternate;}
  @keyframes float1{from{transform:translate(-55%,-52%) rotate(0deg);}to{transform:translate(-45%,-48%) rotate(15deg);}}
  @keyframes float2{from{transform:translate(-45%,-48%) rotate(0deg);}to{transform:translate(-55%,-52%) rotate(-12deg);}}
  /* Header */
  header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--card);border-bottom:1px solid var(--stroke);position:sticky;top:0;z-index:20}
  header h1{font-size:18px;margin:0}
  .nav{margin-left:auto;display:flex;gap:8px}
  .btn,.ghost{border:none;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  .btn{background:var(--accent);color:#fff}
  .ghost{background:transparent;border:1px solid var(--stroke);color:var(--ink)}
  .ghost#statsBtn{color:var(--accent);border-color:rgba(124,58,237,.35)}
  .ghost#statsBtn:hover{background:var(--accent);color:#fff;box-shadow:0 0 14px var(--accent)}
  /* Layout */
  .wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px}
  aside{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px;max-height:calc(100vh - 84px);overflow:auto}
  main{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px;min-height:60vh}
  h3{margin:10px 0 8px}
  input[type="text"],input[type="search"],input[type="url"],input[type="email"],input[type="password"]{width:100%;padding:10px;border-radius:10px;background:transparent;border:1px solid var(--stroke);color:var(--ink)}
  .drop{border:2px dashed var(--accent);border-radius:12px;padding:20px;text-align:center;color:var(--muted)}
  .drop.drag{background:rgba(124,58,237,.12)}
  /* Media grid */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
  .card{background:rgba(255,255,255,.02);border:1px solid var(--stroke);border-radius:12px;padding:8px}
  .thumb{width:100%;aspect-ratio:16/9;background:#000;border-radius:8px;overflow:hidden}
  .thumb>img,.thumb>video{width:100%;height:100%;object-fit:cover}
  .meta{display:flex;align-items:center;justify-content:space-between;margin-top:6px;font-size:12px;color:var(--muted)}
  .controls{display:flex;gap:6px;margin-top:6px}
  .controls button{font-size:12px;padding:6px 8px;border-radius:8px;border:1px solid var(--stroke);background:transparent;color:var(--ink);cursor:pointer}
  .controls button:hover{background:rgba(255,255,255,.04)}
  /* Progress */
  .pbar{height:6px;background:rgba(255,255,255,.08);border-radius:6px;overflow:hidden;margin-top:6px}
  .pfill{height:100%;width:0;background:var(--accent);transition:width .2s ease}
  .pfill.done{background:var(--success);box-shadow:0 0 10px var(--success)}
  /* Animated Login Overlay */
  .auth{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.35);backdrop-filter:blur(8px);z-index:50}
  .card-auth{width:min(92vw,420px);background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:28px;box-shadow:0 10px 40px rgba(0,0,0,.35);animation:pop .6s ease}
  @keyframes pop{from{opacity:0;transform:translateY(6px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
  .title{font-size:22px;margin:0 0 6px;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;color:transparent}
  .subtitle{color:var(--muted);font-size:13px;margin:0 0 14px}
  .error{color:#f87171;margin-top:8px;display:none}
</style>

<style>
/* Main app solid background */
html, body { height: 100%; }
body {
  margin: 0;
  background: #0B1220 !important;
  color: inherit;
}
* { backdrop-filter: none !important; -webkit-backdrop-filter: none !important; }
</style>

</head>
<body>
<div class="bg-anim"></div>

<!-- Animated Login (first view) -->
<div id="authScreen" class="auth">
  <div class="card-auth">
    <h2 class="title">📁 MediaTracker Pro</h2>
    <p class="subtitle">Sign in to continue</p>
    <form id="authForm">
      <input id="authEmail" type="email" placeholder="Email" required />
      <div style="height:8px"></div>
      <input id="authPassword" type="password" placeholder="Password" required />
      <div style="height:10px"></div>
      <button id="loginBtn" class="btn" type="submit" style="width:100%;position:relative">
        <span id="loginText">Sign In</span>
        <span id="loginSpin" style="display:none;position:absolute;right:14px;top:50%;width:16px;height:16px;border:2px solid #fff;border-top-color:transparent;border-radius:50%;transform:translateY(-50%);
        animation:spin 1s linear infinite"></span>
      </button>
      <div id="authError" class="error">Invalid credentials</div>
    </form>
  </div>
</div>

<header>
  <h1>🏠 MediaTracker Pro</h1>
  <div class="nav">
    <a id="statsBtn" class="ghost" href="stats.html">📊 Stats</a>
    <button id="signOutBtn" class="ghost">Sign Out</button>
  </div>
</header>

<div id="appContainer" class="wrap" style="display:none">
  <aside>
    <h3>🏠 Main Library</h3>
    <button id="syncNowBtn" class="btn" style="width:100%">🔄 Sync Now</button>

    <h3 style="margin-top:14px">📂 Folders</h3>
    <div style="display:flex;gap:6px">
      <input id="newFolderName" type="text" placeholder="New folder name" />
      <button id="addFolderBtn" class="btn">Add</button>
    </div>
    <div id="folderList" style="margin-top:8px"></div>

    <h3 style="margin-top:16px">📤 Import Folder</h3>
    <button id="importTriggerBtn" class="ghost" style="width:100%">Import Files</button>
    <input id="importFileInput" type="file" multiple hidden>
    <div id="dropZone" class="drop" style="margin-top:8px">Drag & Drop Files Here</div>
    <div id="importPreview" class="subtitle" style="margin-top:8px">Choose files or drag them above.</div>

    <h3 style="margin-top:16px">🌐 Twitter Downloader</h3>
    <input id="tweetUrl" type="url" placeholder="Paste tweet link..." />
    <button id="fetchTweetBtn" class="btn" style="margin-top:6px;width:100%">🔍 Fetch Media</button>
    <div id="tweetPreview" class="subtitle" style="margin-top:8px">Paste a tweet link to preview media.</div>
    <div id="tweetMediaPreview" style="margin-top:8px;display:grid;gap:8px"></div>
  </aside>

  <main>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="searchInput" type="search" placeholder="🔎 Search..." />
      <button id="sortBtn" class="ghost">Sort</button>
    </div>

    <div id="mediaGrid" class="grid" style="margin-top:12px"></div>

    <div id="viewer" style="display:none;margin-top:12px">
      <video id="popupVideo" controls playsinline style="width:100%;max-height:70vh;background:#000;border-radius:12px"></video>
    </div>
  </main>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script>
  // ===== Firebase Init (your original project kept) =====
  const firebaseConfig={
    apiKey:"AIzaSyBH691ymS0uO7JejXC1MGFuhiIElD78UPY",
    authDomain:"personalplayer-c8d3b.firebaseapp.com",
    projectId:"personalplayer-c8d3b",
    storageBucket:"personalplayer-c8d3b.appspot.com",
    messagingSenderId:"396785312809",
    appId:"1:396785312809:web:02290950ec22a13165a838"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore();
  const storage=firebase.storage();

  // ===== Auth Workflow (Animated login first) =====
  const authScreen=document.getElementById('authScreen');
  const authForm=document.getElementById('authForm');
  const authEmail=document.getElementById('authEmail');
  const authPassword=document.getElementById('authPassword');
  const authError=document.getElementById('authError');
  const loginBtn=document.getElementById('loginBtn');
  const loginText=document.getElementById('loginText');
  const loginSpin=document.getElementById('loginSpin');
  const appContainer=document.getElementById('appContainer');
  const signOutBtn=document.getElementById('signOutBtn');

  auth.onAuthStateChanged(async (u)=>{
    if(u){
      authScreen.style.display='none';
      appContainer.style.display='grid';
      await loadVideos();
    }else{
      appContainer.style.display='none';
      authScreen.style.display='flex';
      loginSpin.style.display='none';
      loginBtn.disabled=false; loginText.textContent='Sign In';
    }
  });

  authForm.addEventListener('submit', async (e)=>{
    e.preventDefault(); authError.style.display='none';
    loginBtn.disabled=true; loginText.textContent='Signing in…'; loginSpin.style.display='inline-block';
    try{await auth.signInWithEmailAndPassword(authEmail.value,authPassword.value);}catch(err){
      authError.textContent=err.message||'Login failed'; authError.style.display='block';
      loginBtn.disabled=false; loginSpin.style.display='none'; loginText.textContent='Sign In';
    }
  });
  signOutBtn.onclick=()=>auth.signOut();

  // ===== Elements for features =====
  const mediaGrid=document.getElementById('mediaGrid');
  const popupVideo=document.getElementById('popupVideo');
  const viewer=document.getElementById('viewer');
  const importTriggerBtn=document.getElementById('importTriggerBtn');
  const importFileInput=document.getElementById('importFileInput');
  const dropZone=document.getElementById('dropZone');
  const importPreview=document.getElementById('importPreview');
  const syncNowBtn=document.getElementById('syncNowBtn');
  const tweetUrl=document.getElementById('tweetUrl');
  const fetchTweetBtn=document.getElementById('fetchTweetBtn');
  const tweetPreview=document.getElementById('tweetPreview');
  const tweetMediaPreview=document.getElementById('tweetMediaPreview');

  // ===== Helpers =====
  function cardEl(data,id){
    const el=document.createElement('div'); el.className='card';
    const t=document.createElement('div'); t.className='thumb';
    if(data.type==='photo'){const img=document.createElement('img'); img.src=data.url; t.appendChild(img);} else {const vid=document.createElement('video'); vid.src=data.url; if(data.thumbUrl) vid.poster=data.thumbUrl; vid.muted=true; t.appendChild(vid);} 
    el.appendChild(t);
    const meta=document.createElement('div'); meta.className='meta'; meta.innerHTML=`<span title="${data.name}">${data.name}</span><span>${(data.size||0)/1e6>=1?((data.size/1e6).toFixed(1)+' MB'):''}</span>`; el.appendChild(meta);
    const ctr=document.createElement('div'); ctr.className='controls';
    ctr.innerHTML=`<button onclick="renameMedia('${id}','${data.name.replace(/'/g,"&#39;")}')">✏️ Rename</button><button onclick="deleteMedia('${id}')">🗑️ Delete</button>`; el.appendChild(ctr);
    el.onclick=(e)=>{if(e.target.tagName==='BUTTON')return; openViewer(data.url)};
    return el;
  }
  function openViewer(url){popupVideo.src=url; viewer.style.display='block'; popupVideo.play();}
  document.addEventListener('click',(e)=>{if(!e.target.closest('#viewer')&&!e.target.closest('.card')){popupVideo.pause();popupVideo.src='';viewer.style.display='none';}});

  // ===== Upload & List =====
  async function uploadFile(file,type,opts={}){
    const id='f_'+Date.now()+Math.random().toString(16).slice(2);
    const path=`media/${id}_${file.name}`;
    const ref=storage.ref(path);
    const snap=await ref.put(file);
    const url=await ref.getDownloadURL();
    const doc={name:file.name,url,type,size:file.size,createdAt:firebase.firestore.FieldValue.serverTimestamp(),path};
    if(opts.thumbUrl) doc.thumbUrl=opts.thumbUrl;
    await db.collection('videos').doc(id).set(doc);
    return {id,url,doc};
  }

  async function loadVideos(){
    mediaGrid.innerHTML='';
    const snap=await db.collection('videos').orderBy('createdAt','desc').get();
    snap.forEach(d=>{const data=d.data(); mediaGrid.appendChild(cardEl(data,d.id));});
  }

  // ===== Drag & Drop / Import (preview first, then upload) =====
  importTriggerBtn.onclick=()=>importFileInput.click();
  importFileInput.onchange=(e)=>handleDropFiles(e.target.files);
  ;['dragenter','dragover'].forEach(ev=>dropZone.addEventListener(ev,(e)=>{e.preventDefault(); dropZone.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev=>dropZone.addEventListener(ev,(e)=>{e.preventDefault(); dropZone.classList.remove('drag');}));
  dropZone.addEventListener('drop',(e)=>handleDropFiles(e.dataTransfer.files));

  async function handleDropFiles(fileList){
    const files=[...fileList]; if(!files.length) return; importPreview.textContent=`Uploading ${files.length} file(s)...`;
    for(const file of files){ await displayThenUpload(file); }
    importPreview.textContent='Upload complete.'; await loadVideos();
  }

  async function displayThenUpload(file){
    // show card immediately with local preview
    const tempId='temp_'+Date.now();
    const el=document.createElement('div'); el.className='card';
    const t=document.createElement('div'); t.className='thumb';
    const isVideo=file.type.startsWith('video/');
    if(isVideo){const v=document.createElement('video'); v.src=URL.createObjectURL(file); v.controls=false; v.muted=true; t.appendChild(v);} else {const img=document.createElement('img'); img.src=URL.createObjectURL(file); t.appendChild(img);} 
    el.appendChild(t); const pb=document.createElement('div'); pb.className='pbar'; pb.innerHTML='<div class="pfill"></div>'; el.appendChild(pb); mediaGrid.prepend(el);

    let thumbUrl=undefined;
    if(isVideo){ // create custom thumbnail (1s frame)
      thumbUrl=await captureThumb(file).catch(()=>undefined);
    }
    // upload (no progress API here; relies on pfill to turn green once done)
    const pfill=pb.querySelector('.pfill');
    const {doc}=await uploadFile(file,isVideo?'video':'photo',{thumbUrl});
    pfill.style.width='100%'; pfill.classList.add('done');
  }

  function captureThumb(file){
    return new Promise((resolve,reject)=>{
      const v=document.createElement('video'); v.src=URL.createObjectURL(file); v.muted=true; v.currentTime=1;
      v.onloadeddata=()=>{
        const c=document.createElement('canvas'); c.width=v.videoWidth; c.height=v.videoHeight; c.getContext('2d').drawImage(v,0,0,c.width,c.height);
        c.toBlob(async (blob)=>{
          if(!blob) return reject();
          const name=file.name.replace(/\.[^/.]+$/, '')+'_thumb.jpg';
          const {doc}=await uploadFile(new File([blob],name,{type:'image/jpeg'}),'photo');
          resolve(doc.url);
        },'image/jpeg',0.85);
      };
      v.onerror=()=>reject();
    });
  }

  // ===== Rename / Delete =====
  window.renameMedia=async (id,oldName)=>{
    const nn=prompt('New name:', oldName); if(!nn||nn===oldName) return;
    await db.collection('videos').doc(id).update({name:nn}); await loadVideos();
  }
  window.deleteMedia=async (id)=>{
    if(!confirm('Delete this item?')) return;
    const docRef=db.collection('videos').doc(id); const d=await docRef.get(); const data=d.data();
    if(data&&data.path){ await storage.ref(data.path).delete().catch(()=>{}); }
    await docRef.delete(); await loadVideos();
  }

  // ===== Sync =====
  syncNowBtn.onclick=()=>loadVideos();

  // ===== FixTweet Downloader (preview -> upload; tweetID-named; show immediately) =====
  fetchTweetBtn.onclick=async ()=>{
    const url=(tweetUrl.value||'').trim(); if(!url) return alert('Enter a tweet URL');
    tweetPreview.textContent='Fetching from FixTweet…'; tweetMediaPreview.innerHTML='';
    try{
      const idMatch=url.match(/status\/(\d+)/); const tid=idMatch? idMatch[1] : url.split('/').pop();
      const res=await fetch(`https://api.fxtwitter.com/${encodeURIComponent(tid)}`);
      const data=await res.json();
      if(!data||!data.tweet){ tweetPreview.textContent='No tweet data.'; return; }
      const medias=(data.tweet.media?.videos||[]).map(v=>({type:'video',url:v.url,preview_url:v.thumbnail_url||v.url}))
        .concat((data.tweet.media?.photos||[]).map(p=>({type:'photo',url:p.url,preview_url:p.url})));
      if(!medias.length){ tweetPreview.textContent='No media found in this tweet.'; return; }
      tweetPreview.textContent=`Found ${medias.length} media file(s) by @${data.tweet.author?.screen_name||'unknown'}`;
      for(let i=0;i<medias.length;i++){
        const m=medias[i];
        const wrap=document.createElement('div'); wrap.className='card';
        const th=document.createElement('div'); th.className='thumb';
        if(m.type==='video'){const v=document.createElement('video'); v.src=m.preview_url; v.controls=true; th.appendChild(v);} else {const img=document.createElement('img'); img.src=m.preview_url; th.appendChild(img);} wrap.appendChild(th);
        const b=document.createElement('button'); b.className='btn'; b.style.marginTop='6px'; b.textContent='📥 Upload to Firebase';
        b.onclick=async ()=>{
          const blob=await (await fetch(m.url)).blob();
          const ext=m.type==='video'?'.mp4':'.jpg'; const fname=`tweet_${tid}_${i}${ext}`;
          // show in grid immediately
          await displayThenUpload(new File([blob], fname, {type: blob.type})); await loadVideos();
        };
        wrap.appendChild(b); tweetMediaPreview.appendChild(wrap);
      }
    }catch(e){ console.error(e); tweetPreview.textContent='Error fetching tweet media.'; }
  }

  // minor
  function $(q){return document.querySelector(q)}
</script>

<script>
if (window.firebase && firebase.auth) {
  firebase.auth().onAuthStateChanged(function(u){
    if (!u) window.location.replace("login.html");
  });
}
</script>

</body>
</html>
