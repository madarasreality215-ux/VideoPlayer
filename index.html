<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MediaTracker Pro - Your Ultimate Media Organizer</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7c3aed">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MediaTracker">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">

<style>
  :root{
    --bg-light:#f3f4f6;
    --bg-dark:#0b1220;
    --card-light:#ffffff;
    --card-dark:#0f1724;
    --text-light:#0f1724;
    --text-dark:#e6eef9;
    --accent:#7c3aed;
    --accent-hover:#6d28d9;
    --muted:rgba(230,238,249,0.65);
    --thumb-size:120px;
    --safe-area: env(safe-area-inset-bottom, 16px);
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:var(--bg-dark);color:var(--text-dark);transition:background .2s,color .2s}
  body.light{background:var(--bg-light);color:var(--text-light)}
  
  /* App container - hidden until authenticated */
  #appContainer{display:none}
  #appContainer.authenticated{display:block}
  
  header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--card-dark);position:sticky;top:0;z-index:100;}
  body.light header{background:var(--card-light)}
  h1{margin:0;font-size:18px}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:white;padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:background .2s}
  .btn:hover{background:var(--accent-hover)}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:inherit;cursor:pointer;transition:background .2s}
  .ghost:hover{background:rgba(255,255,255,0.05)}
  body.light .ghost{border-color:rgba(0,0,0,0.08)}
  body.light .ghost:hover{background:rgba(0,0,0,0.05)}
  
  .container{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px;min-height:calc(100vh - 60px)}
  @media (max-width:960px){.container{grid-template-columns:1fr;}}
  @media (max-width:768px){.container{padding:12px;gap:12px;}}
  @media (max-width:480px){.container{padding:8px;gap:8px;}}
  
  .sidebar{background:var(--card-dark);padding:12px;border-radius:12px;min-height:60vh}
  body.light .sidebar{background:var(--card-light)}
  .main{background:var(--card-dark);padding:12px;border-radius:12px;min-height:60vh}
  body.light .main{background:var(--card-light)}

  .topbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  input[type=search]{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
  body.light input[type=search]{border-color:rgba(0,0,0,0.08)}

  .folders{display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow:auto;padding-right:6px}
  .folder{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;transition:background .2s}
  .folder:hover{background:rgba(255,255,255,0.05)}
  .folder .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .folder .count{font-size:12px;color:var(--muted)}
  
  /* Folder collapse/expand styles */
  .folder-header{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;transition:background-color 0.2s}
  .folder-header:hover{background:rgba(255,255,255,0.05)}
  .folder-header .icon{transition:transform 0.2s;width:16px;height:16px;display:flex;align-items:center;justify-content:center}
  .folder-header.collapsed .icon{transform:rotate(-90deg)}
  .folder-content{overflow:hidden;transition:max-height 0.3s ease-out}
  .folder-content.collapsed{max-height:0}
  .nested-folder{margin-left:20px;border-left:1px solid rgba(255,255,255,0.1);padding-left:8px}
  body.light .nested-folder{border-left-color:rgba(0,0,0,0.1)}

  .videoList{display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow:auto}
  .vitem{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;transition:background .2s}
  .vitem:hover{background:rgba(255,255,255,0.05)}
  .vitem.dragging{opacity:0.5;background:rgba(124,58,237,0.2);transform:scale(0.95)}
  .vitem.drop-target{background:rgba(124,58,237,0.1);border:2px dashed var(--accent)}
  .folder.drop-target{background:rgba(124,58,237,0.1);border:2px dashed var(--accent)}
  .thumb{width:var(--thumb-size);height:calc(var(--thumb-size)*0.6);background:#000;border-radius:8px;overflow:hidden;flex-shrink:0}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .meta{flex:1;min-width:0}
  .meta h3{margin:0;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta p{margin:4px 0 0 0;font-size:12px;color:var(--muted)}

  .viewer video{width:100%;height:auto;max-height:70vh;background:#000;border-radius:8px}
  .fields{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .fields input,.fields textarea,.fields select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px;flex:1;min-width:150px}
  body.light .fields input,body.light .fields textarea,body.light .fields select{border-color:rgba(0,0,0,0.08)}
  .small{font-size:12px;color:var(--muted)}

  .folder-actions{display:flex;gap:8px;margin-top:8px}
  .collapse{opacity:0.8}
  .controls .btn-sm{padding:6px 8px;font-size:13px}

  /* Action Sections */
  .action-section{margin-top:16px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.04)}
  body.light .action-section{background:rgba(0,0,0,0.02);border-color:rgba(0,0,0,0.08)}
  .action-section h3{margin:0 0 8px 0;font-size:14px;color:var(--accent)}
  .action-buttons{display:flex;flex-direction:column;gap:8px}
  .action-buttons .btn,.action-buttons .ghost{width:100%;justify-content:center;text-align:center}
  
  /* Mobile-specific styles - Enhanced for iOS/Android */
  .mobile-controls{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--card-dark);padding:12px;border-top:1px solid rgba(255,255,255,0.1);z-index:100;padding-bottom: calc(12px + var(--safe-area))}
  body.light .mobile-controls{background:var(--card-light);border-top-color:rgba(0,0,0,0.1)}
  .mobile-controls-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  
  /* Media type indicators */
  .media-type-badge{background:var(--accent);color:white;padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600}
  .media-type-photo{background:#10b981}
  .media-type-video{background:#7c3aed}
  
  /* Add Media Buttons */
  .add-media-buttons{display:flex;gap:8px;margin-top:8px}
  .add-media-buttons .btn{flex:1;min-width:0} /* Ensure equal width */
  
  /* Firebase sync status */
  .sync-status{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted);margin-top:8px}
  .sync-indicator{width:8px;height:8px;border-radius:50%;background:#10b981}
  .sync-indicator.syncing{background:#f59e0b;animation:pulse 1.5s infinite}
  .sync-indicator.error{background:#ef4444}
  @keyframes pulse{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}
  
  /* Auth Screen Styles */
  #authScreen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg-dark);color:var(--text-dark);transition:background .2s,color .2s}
  body.light #authScreen{background:var(--bg-light);color:var(--text-light)}
  .auth-container{width:90%;max-width:400px;padding:40px 0}
  .auth-card{background:var(--card-dark);padding:32px;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,0.3);text-align:center}
  body.light .auth-card{background:var(--card-light)}
  .auth-logo{font-size:28px;font-weight:700;margin-bottom:8px;color:var(--accent)}
  .auth-subtitle{color:var(--muted);margin-bottom:32px;font-size:16px}
  .auth-form{display:flex;flex-direction:column;gap:16px}
  .auth-form input{padding:14px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:inherit;font-size:16px;width:100%}
  body.light .auth-form input{border-color:rgba(0,0,0,0.1);background:rgba(0,0,0,0.05)}
  .auth-primary-btn{background:var(--accent);color:white;padding:14px;border-radius:8px;border:none;cursor:pointer;font-weight:600;font-size:16px;transition:background .2s;width:100%}
  .auth-primary-btn:hover{background:var(--accent-hover)}
  .auth-secondary-btn{background:transparent;border:1px solid rgba(255,255,255,0.1);color:inherit;padding:14px;border-radius:8px;cursor:pointer;font-size:16px;transition:background .2s;width:100%}
  .auth-secondary-btn:hover{background:rgba(255,255,255,0.05)}
  .auth-switch{text-align:center;margin-top:24px;font-size:15px;color:var(--muted)}
  .auth-switch-btn{background:none;border:none;color:var(--accent);cursor:pointer;text-decoration:underline;font-size:15px;margin-left:4px}
  .auth-error{color:#ef4444;font-size:14px;text-align:center;margin-top:12px;display:none}
  .auth-loading{display:none;text-align:center;margin-top:16px}

  /* Upload Progress Styles */
  .upload-progress {margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid rgba(255,255,255,0.04)}
  .progress-bar {width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 8px}
  .progress-fill {height: 100%; background: var(--accent); transition: width 0.3s ease}
  .progress-text {font-size: 12px; color: var(--muted); margin-top: 4px}
  .duplicate-warning {background: rgba(245,158,11,0.1); border: 1px solid rgba(245,158,11,0.3); padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 12px}
  
  /* Cloud Storage Styles */
  .cloud-storage-dropdown {position: relative; display: inline-block; width: 100%;}
  .cloud-storage-btn {width: 100%; padding: 10px; background: transparent; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: inherit; cursor: pointer; display: flex; align-items: center; justify-content: space-between; font-size: 14px;}
  .cloud-storage-btn:hover {background: rgba(255,255,255,0.05);}
  .cloud-dropdown-content {display: none; position: absolute; top: 100%; left: 0; right: 0; background: var(--card-dark); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 8px; z-index: 1000; margin-top: 4px;}
  .cloud-dropdown-content.show {display: block;}
  .cloud-option {padding: 10px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background 0.2s;}
  .cloud-option:hover {background: rgba(255,255,255,0.05);}
  .cloud-option.google {color: #4285F4;}
  .cloud-option.dropbox {color: #0061FF;}
  .cloud-option.mega {color: #D90007;}
  .cloud-browser {margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid rgba(255,255,255,0.04); display: none;}
  .cloud-browser.show {display: block;}
  .cloud-folder {padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;}
  .cloud-folder:hover {background: rgba(255,255,255,0.05);}
  .cloud-file {padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 4px;}
  .cloud-file:hover {background: rgba(255,255,255,0.05);}
  .cloud-back {padding: 8px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; margin-bottom: 8px; color: var(--accent);}
  .cloud-back:hover {background: rgba(255,255,255,0.05);}

  /* Custom Modal Styles */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }
  .modal-overlay.show {
    display: flex;
  }
  .modal {
    background: var(--card-dark);
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }
  body.light .modal {
    background: var(--card-light);
  }
  .modal h3 {
    margin: 0 0 16px 0;
    color: var(--accent);
  }
  .modal-buttons {
    display: flex;
    gap: 12px;
    margin-top: 20px;
    justify-content: flex-end;
  }
  .modal-buttons .btn {
    min-width: 80px;
  }

  /* Enhanced Video Player */
  .video-player-container {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
  }
  .video-controls {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    opacity: 0;
    transition: opacity 0.3s;
  }
  .video-player-container:hover .video-controls {
    opacity: 1;
  }
  .control-btn {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
  }
  .progress-container {
    flex: 1;
    height: 4px;
    background: rgba(255,255,255,0.3);
    border-radius: 2px;
    cursor: pointer;
    position: relative;
  }
  .progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 2px;
    width: 0%;
  }
  .time-display {
    color: white;
    font-size: 14px;
    min-width: 100px;
    text-align: center;
  }

  /* URL Downloader */
  .url-downloader {
    margin-top: 12px;
    padding: 12px;
    background: rgba(255,255,255,0.02);
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.04);
  }
  .url-input-group {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }
  .url-input-group input {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.05);
    color: inherit;
  }

  /* File Conversion Tools */
  .conversion-tools {
    margin-top: 12px;
    padding: 12px;
    background: rgba(255,255,255,0.02);
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.04);
  }
  .conversion-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 8px;
  }
  .conversion-option {
    padding: 10px;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: background 0.2s;
  }
  .conversion-option:hover {
    background: rgba(255,255,255,0.05);
  }

  /* Install Prompt */
  .install-prompt {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: var(--accent);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    display: none;
    align-items: center;
    gap: 12px;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  }
  .install-prompt.show {
    display: flex;
  }
  .install-close {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 18px;
  }

  /* Context Menu */
  .context-menu {
    position: fixed;
    background: var(--card-dark);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    padding: 8px;
    z-index: 1000;
    display: none;
    min-width: 150px;
  }
  .context-menu.show {
    display: block;
  }
  .context-item {
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s;
  }
  .context-item:hover {
    background: rgba(255,255,255,0.05);
  }
  .context-item.danger {
    color: #ef4444;
  }

  /* Enhanced mobile styles */
  @media (max-width:768px){
    .container{min-height:calc(100vh - 120px);margin-bottom:70px}
    .mobile-controls{display:block}
    .desktop-controls{display:none}
    .folders, .videoList{max-height:30vh}
    .fields{flex-direction:column}
    .fields input,.fields textarea,.fields select{min-width:auto}
    .viewer video{max-height:50vh}
    .thumb{width:80px;height:48px}
    
    /* Better touch targets for mobile */
    .vitem, .folder, .folder-header{padding:12px 10px;min-height:48px}
    .btn, .ghost{min-height:44px;display:flex;align-items:center;justify-content:center}
    
    /* Improved mobile header */
    header{padding:10px 12px}
    h1{font-size:16px}
    
    /* Better mobile controls layout */
    .mobile-controls-grid{grid-template-columns:1fr 1fr;gap:8px}
    
    /* Mobile auth styles */
    .auth-card{padding:24px;margin:20px}
    .auth-container{padding:20px 0}

    /* Mobile video controls */
    .video-controls {
      opacity: 1;
      padding: 12px;
    }
    .control-btn {
      font-size: 18px;
      padding: 6px;
    }

    /* Mobile conversion tools */
    .conversion-options {
      grid-template-columns: 1fr;
    }
  }
  
  @media (max-width:480px){
    header{padding:8px 12px}
    .container{padding-bottom:80px}
    .sidebar, .main{padding:8px}
    .mobile-controls{padding:10px}
    .mobile-controls-grid{grid-template-columns:1fr 1fr;gap:6px}
    .action-buttons .btn,.action-buttons .ghost{padding:10px;font-size:14px}
    
    /* Stack add media buttons on very small screens */
    .add-media-buttons{flex-direction:column}
    
    /* Mobile auth styles */
    .auth-card{padding:20px 16px}

    /* Mobile install prompt */
    .install-prompt {
      bottom: 80px;
      right: 12px;
      left: 12px;
    }
  }

  /* Tablet-specific improvements */
  @media (min-width:769px) and (max-width:1024px){
    .container{grid-template-columns:280px 1fr;gap:12px}
    .thumb{width:100px;height:60px}
  }

  /* Touch-friendly improvements for all touch devices */
  @media (hover: none) and (pointer: coarse){
    .vitem, .folder, .folder-header{padding:14px 10px;min-height:52px}
    .btn, .ghost{min-height:48px;display:flex;align-items:center;justify-content:center;font-size:15px}
    input, textarea, select{font-size:16px;padding:12px 10px} /* Prevents zoom on iOS */
    
    /* Better touch feedback */
    .vitem:active, .folder:active, .folder-header:active{background:rgba(124,58,237,0.2)}

    /* Always show video controls on touch devices */
    .video-controls {
      opacity: 1;
    }
  }

  /* iOS Safari specific fixes */
  @supports (-webkit-touch-callout: none) {
    .mobile-controls{padding-bottom: max(12px, var(--safe-area))}
    .container{min-height: calc(100vh - 60px - env(safe-area-inset-bottom))}
    
    /* iPhone 12 Pro Max specific optimizations */
    @media (device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) {
      .container{min-height: calc(100vh - 60px - 34px)} /* Account for dynamic island */
      .mobile-controls{padding-bottom: max(12px, 34px)}
    }
  }
</style>
</head>
<body>
<!-- Authentication Screen (Shown First) -->
<div id="authScreen">
  <div class="auth-container">
    <div class="auth-card">
      <div class="auth-logo">📱 MediaTracker Pro</div>
      <div class="auth-subtitle" id="authSubtitle">Sign in to your media library 📂</div>
      
      <div id="authError" class="auth-error"></div>
      <div id="authLoading" class="auth-loading">
        <div class="small">Loading...</div>
      </div>
      
      <form id="authForm" class="auth-form">
        <input type="email" id="authEmail" placeholder="Email" required>
        <input type="password" id="authPassword" placeholder="Password" required>
        <button type="submit" id="authSubmit" class="auth-primary-btn">Sign In</button>
      </form>
      
      <div class="auth-switch">
        <span id="authSwitchText">Don't have an account?</span>
        <button type="button" id="authSwitchBtn" class="auth-switch-btn">Sign Up</button>
      </div>
    </div>
  </div>
</div>

<!-- Main App (Hidden until authenticated) -->
<div id="appContainer">
  <header>
    <h1>📱 MediaTracker Pro</h1>
    <div class="controls desktop-controls">
      <!-- Stats button with improved navigation -->
      <a href="stats.html" class="ghost" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 4px;">
        📊 Stats
      </a>
      <button id="themeBtn" class="ghost">🌙</button>
      <button id="signOutBtn" class="ghost">🚪 Sign Out</button>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div class="topbar">
        <button id="syncBtn" class="btn" style="flex:1">🔄 Sync Now</button>
      </div>

      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <input id="newFolderName" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit" placeholder="New folder name">
        <button id="addFolderBtn" class="btn btn-sm">📁 Add</button>
      </div>

      <div class="folders" id="folders"></div>

      <!-- Add Media Section -->
      <div class="action-section">
        <h3>➕ Add Media</h3>
        <div class="add-media-buttons">
          <label style="display:block;flex:1">
            <input id="fileInputVideo" type="file" accept="video/*" multiple style="display:none">
            <button id="addVideoBtn" class="btn">🎥 Add Videos</button>
          </label>
          <label style="display:block;flex:1">
            <input id="fileInputPhoto" type="file" accept="image/*" multiple style="display:none">
            <button id="addPhotoBtn" class="btn" style="background:#10b981">📷 Add Photos</button>
          </label>
        </div>
        <div class="small" style="text-align:center;margin-top:4px">Supports MP4, WebM, MOV, JPG, PNG, GIF</div>
        
        <!-- URL Downloader -->
        <div class="url-downloader">
          <div class="url-input-group">
            <input type="url" id="videoUrl" placeholder="Paste video URL (MP4)">
            <button id="downloadUrlBtn" class="btn">📥 Download</button>
          </div>
          <div class="small" style="text-align:center">Download videos from direct links</div>
        </div>

        <!-- Folder Upload Section -->
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1)">
          <label style="display:block;width:100%">
            <input id="folderInput" type="file" webkitdirectory directory multiple style="display:none">
            <button id="addFolderBtn" class="ghost" style="width:100%">📂 Upload Local Folder</button>
          </label>
          <div class="small" style="text-align:center;margin-top:4px">Upload entire folders from your computer</div>
        </div>

        <!-- Cloud Storage Section -->
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1)">
          <div class="cloud-storage-dropdown">
            <button class="cloud-storage-btn" id="cloudStorageBtn">
              <span>☁️ Import from Cloud Storage</span>
              <span>▼</span>
            </button>
            <div class="cloud-dropdown-content" id="cloudDropdown">
              <div class="cloud-option google" data-provider="google">
                <span>📁</span>
                <span>Google Drive</span>
              </div>
              <div class="cloud-option dropbox" data-provider="dropbox">
                <span>📁</span>
                <span>Dropbox</span>
              </div>
              <div class="cloud-option mega" data-provider="mega">
                <span>📁</span>
                <span>MEGA</span>
              </div>
            </div>
          </div>
          <div class="small" style="text-align:center;margin-top:4px">Import from cloud storage providers</div>

          <!-- Cloud Browser -->
          <div class="cloud-browser" id="cloudBrowser">
            <div class="cloud-back" id="cloudBack" style="display:none;">
              <span>←</span>
              <span>Back</span>
            </div>
            <div id="cloudContent">
              <div class="small" style="text-align:center;padding:20px;color:var(--muted)">
                Select a cloud provider to browse files
              </div>
            </div>
          </div>
        </div>

        <!-- File Conversion Tools -->
        <div class="conversion-tools">
          <h4>🛠️ Conversion Tools</h4>
          <div class="conversion-options">
            <div class="conversion-option" data-convert="compress">
              <div>📦</div>
              <div class="small">Compress</div>
            </div>
            <div class="conversion-option" data-convert="format">
              <div>🔄</div>
              <div class="small">Format</div>
            </div>
            <div class="conversion-option" data-convert="resolution">
              <div>📐</div>
              <div class="small">Resolution</div>
            </div>
            <div class="conversion-option" data-convert="trim">
              <div>✂️</div>
              <div class="small">Trim</div>
            </div>
          </div>
        </div>

        <!-- Upload Progress -->
        <div id="uploadProgress" class="upload-progress" style="display:none">
          <div class="small">Uploading files...</div>
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill" style="width:0%"></div>
          </div>
          <div id="progressText" class="progress-text">0/0 files</div>
          <div id="duplicateWarning" class="duplicate-warning" style="display:none">
            <strong>Duplicates found:</strong> <span id="duplicateCount">0</span> files skipped
          </div>
        </div>
      </div>

      <div class="action-section">
        <h3>💾 Export & Import</h3>
        <div class="action-buttons">
          <button id="exportBtn2" class="ghost">📤 Export Library</button>
          <label style="display:block">
            <input id="importInput2" type="file" accept=".json" style="display:none">
            <button class="ghost" id="importBtn2">📥 Import Library</button>
          </label>
          <div class="sync-status" id="syncStatus">
            <div class="sync-indicator" id="syncIndicator"></div>
            <span id="syncText">Connected</span>
          </div>
          <div class="small" style="text-align:center;margin-top:4px">Backup and restore your library</div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div id="emptyMain" class="small">Select a video or photo to view details here.</div>
      <div id="viewerArea" style="display:none">
        <div class="video-player-container" id="mediaContainer">
          <video id="player" controls playsinline></video>
          <div class="video-controls">
            <button class="control-btn" id="playPauseBtn">⏯️</button>
            <div class="progress-container" id="progressContainer">
              <div class="progress-bar" id="videoProgress"></div>
            </div>
            <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
            <button class="control-btn" id="fullscreenBtn">⛶</button>
          </div>
          <img id="photoViewer" style="display:none;width:100%;max-height:70vh;object-fit:contain;border-radius:8px">
        </div>
        
        <div class="fields">
          <input id="titleInput" placeholder="Media title">
          <select id="folderSelect"></select>
        </div>
        <div style="margin-top:8px">
          <textarea id="notesInput" rows="4" placeholder="Notes..."></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;align-items:center;flex-wrap:wrap">
          <button id="saveMeta" class="btn">💾 Save</button>
          <button id="downloadBtn" class="ghost">📥 Download</button>
          <button id="moveBtn" class="ghost">📂 Move</button>
          <button id="deleteBtn" class="ghost">🗑️ Delete</button>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <label class="small">Thumb size</label>
            <input id="thumbRange" type="range" min="80" max="240" value="120">
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Mobile Controls -->
  <div class="mobile-controls">
    <div class="mobile-controls-grid">
      <label style="display:block">
        <input id="fileInputVideoMobile" type="file" accept="video/*" multiple style="display:none">
        <button id="addVideoBtnMobile" class="btn">🎥 Videos</button>
      </label>
      <label style="display:block">
        <input id="fileInputPhotoMobile" type="file" accept="image/*" multiple style="display:none">
        <button id="addPhotoBtnMobile" class="btn" style="background:#10b981">📷 Photos</button>
      </label>
      <label style="display:block">
        <input id="folderInputMobile" type="file" webkitdirectory directory multiple style="display:none">
        <button id="addFolderBtnMobile" class="ghost">📂 Folder</button>
      </label>
      <button id="syncBtnMobile" class="ghost">🔄 Sync</button>
    </div>
  </div>
</div>

<!-- Custom Modal -->
<div class="modal-overlay" id="customModal">
  <div class="modal">
    <h3 id="modalTitle">Confirm Action</h3>
    <p id="modalMessage">Are you sure you want to proceed?</p>
    <div class="modal-buttons">
      <button class="ghost" id="modalCancel">Cancel</button>
      <button class="btn" id="modalConfirm">Confirm</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
  <div class="context-item" data-action="rename">✏️ Rename</div>
  <div class="context-item" data-action="delete-folder">🗑️ Delete Folder</div>
  <div class="context-item" data-action="add-subfolder">📁 Add Subfolder</div>
</div>

<!-- Install Prompt -->
<div class="install-prompt" id="installPrompt">
  <span>Install MediaTracker Pro for better experience</span>
  <button class="install-close" id="installClose">✕</button>
  <button class="btn" id="installBtn">Install</button>
</div>

<!-- Firebase SDK - USING ES MODULES LIKE STATS.HTML -->
<script type="module">
  // Import Firebase modules - SAME AS STATS.HTML
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
  import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBH691ymS0uO7JejXC1MGFuhiIElD78UPY",
    authDomain: "personalplayer-c8d3b.firebaseapp.com",
    projectId: "personalplayer-c8d3b",
    storageBucket: "personalplayer-c8d3b.firebasestorage.app",
    messagingSenderId: "396785312809",
    appId: "1:396785312809:web:02290950ec22a13165a838"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // Make Firebase available globally for compatibility
  window.firebase = {
    app, auth, db, storage,
    // Auth methods
    createUserWithEmailAndPassword, 
    signInWithEmailAndPassword, 
    signOut, 
    onAuthStateChanged,
    // Firestore methods
    collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where, orderBy, onSnapshot, serverTimestamp,
    // Storage methods
    ref, uploadBytesResumable, getDownloadURL, deleteObject
  };

  // Cloud Storage Configuration
  const CLOUD_CONFIG = {
    google: {
      clientId: '396785312809-rgdurhgugg8g8fu2krnr53iukaigdm13.apps.googleusercontent.com',
      clientSecret: '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',
      apiKey: 'AIzaSyBH691ymS0uO7JejXC1MGFuhiIElD78UPY',
      scope: 'https://www.googleapis.com/auth/drive.readonly'
    },
    dropbox: {
      appKey: 'iy5lgx8guukd2q3',
      appSecret: 'odyx14bbiaylvqs'
    },
    mega: {
      // MEGA doesn't require API keys for basic file access
    }
  };

  // Global variables
  let currentUser = null;
  let isSignUpMode = false;
  let folders = [];

  // Cloud Storage State
  let currentCloudProvider = null;
  let currentCloudPath = [];
  let cloudAuthState = {
    google: null,
    dropbox: null,
    mega: null
  };

  // Drag and drop state
  let dragState = {
    isDragging: false,
    draggedItem: null,
    draggedItemElement: null,
    sourceFolderId: null
  };

  // Video player state
  let videoPlayerState = {
    isPlaying: false,
    currentTime: 0,
    duration: 0,
    isFullscreen: false
  };

// ========== AUTHENTICATION FUNCTIONS ==========
function setupAuthEventListeners() {
  const authForm = document.getElementById('authForm');
  const authSwitchBtn = document.getElementById('authSwitchBtn');
  const authSwitchText = document.getElementById('authSwitchText');
  const authSubtitle = document.getElementById('authSubtitle');

  authForm.addEventListener('submit', handleAuthSubmit);
  
  authSwitchBtn.addEventListener('click', function() {
    isSignUpMode = !isSignUpMode;
    updateAuthUI();
  });

  // Set up auth state listener
  onAuthStateChanged(auth, (user) => {
    if (user) {
      currentUser = user;
      console.log('User signed in:', user.email);
      showApp();
      loadDataFromFirebase();
    } else {
      currentUser = null;
      console.log('User signed out');
      showAuthScreen();
    }
  });

  // Initialize auth UI
  updateAuthUI();
}

function updateAuthUI() {
  const authSwitchText = document.getElementById('authSwitchText');
  const authSwitchBtn = document.getElementById('authSwitchBtn');
  const authSubtitle = document.getElementById('authSubtitle');
  const authSubmit = document.getElementById('authSubmit');

  if (isSignUpMode) {
    authSwitchText.textContent = 'Already have an account?';
    authSwitchBtn.textContent = 'Sign In';
    authSubtitle.textContent = 'Create your media library account 🎉';
    authSubmit.textContent = 'Sign Up';
  } else {
    authSwitchText.textContent = 'Don\'t have an account?';
    authSwitchBtn.textContent = 'Sign Up';
    authSubtitle.textContent = 'Sign in to your media library 📂';
    authSubmit.textContent = 'Sign In';
  }
}

async function handleAuthSubmit(e) {
  e.preventDefault();
  
  const email = document.getElementById('authEmail').value;
  const password = document.getElementById('authPassword').value;
  const authError = document.getElementById('authError');
  const authLoading = document.getElementById('authLoading');
  
  // Basic validation
  if (!email || !password) {
    showError('Please fill in all fields', authError);
    return;
  }
  
  if (password.length < 6) {
    showError('Password must be at least 6 characters', authError);
    return;
  }
  
  showLoading(true, authLoading);
  hideError(authError);
  
  try {
    let userCredential;
    
    if (isSignUpMode) {
      // Sign up
      userCredential = await createUserWithEmailAndPassword(auth, email, password);
      console.log('User created:', userCredential.user);
      
      // Create user document in Firestore
      await createUserDocument(userCredential.user);
      
      showError('Account created successfully!', authError, false);
    } else {
      // Sign in
      userCredential = await signInWithEmailAndPassword(auth, email, password);
      console.log('User signed in:', userCredential.user);
    }
    
    // Reset form
    document.getElementById('authForm').reset();
    
  } catch (error) {
    console.error('Auth error:', error);
    handleAuthError(error, authError);
  } finally {
    showLoading(false, authLoading);
  }
}

async function createUserDocument(user) {
  try {
    const userDocRef = doc(db, 'users', user.uid);
    await setDoc(userDocRef, {
      email: user.email,
      createdAt: serverTimestamp(),
      folders: [
        {
          id: 'default',
          name: 'All Media',
          items: [],
          subfolders: [],
          collapsed: false,
          itemCount: 0
        }
      ]
    });
    console.log('User document created');
  } catch (error) {
    console.error('Error creating user document:', error);
  }
}

function handleAuthError(error, errorElement) {
  let errorMessage = 'Authentication failed. ';
  
  switch (error.code) {
    case 'auth/email-already-in-use':
      errorMessage += 'Email already in use.';
      break;
    case 'auth/invalid-email':
      errorMessage += 'Invalid email address.';
      break;
    case 'auth/weak-password':
      errorMessage += 'Password is too weak.';
      break;
    case 'auth/user-not-found':
      errorMessage += 'No account found with this email.';
      break;
    case 'auth/wrong-password':
      errorMessage += 'Incorrect password.';
      break;
    case 'auth/network-request-failed':
      errorMessage += 'Network error. Please check your connection.';
      break;
    default:
      errorMessage += error.message;
  }
  
  showError(errorMessage, errorElement);
}

async function signOutUser() {
  try {
    await signOut(auth);
    console.log('User signed out successfully');
  } catch (error) {
    console.error('Sign out error:', error);
  }
}

// ========== UI FUNCTIONS ==========

  // ========== UI FUNCTIONS ==========
  function showError(message, errorElement, isError = true) {
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    errorElement.style.color = isError ? '#ef4444' : '#10b981';
  }

  function hideError(errorElement) {
    errorElement.style.display = 'none';
  }

  function showLoading(show, loadingElement) {
    loadingElement.style.display = show ? 'block' : 'none';
  }

  function showAuthScreen() {
    document.getElementById('authScreen').style.display = 'flex';
    document.getElementById('appContainer').classList.remove('authenticated');
  }

  function showApp() {
    document.getElementById('authScreen').style.display = 'none';
    document.getElementById('appContainer').classList.add('authenticated');
    initializeApp();
  }

  // ========== CORE APP FUNCTIONS ==========
  async function syncDataToFirebase() {
    if (!currentUser) return;
    
    try {
      updateSyncStatus('⏳ Syncing...', true);
      
      const userDocRef = doc(db, 'users', currentUser.uid);
      await updateDoc(userDocRef, {
        folders: folders,
        lastSync: serverTimestamp()
      });
      
      updateSyncStatus('✓ Synced', false);
    } catch (error) {
      console.error('Sync error:', error);
      updateSyncStatus('⚠️ Sync failed', true);
    }
  }

  async function loadDataFromFirebase() {
    if (!currentUser) return;
    
    try {
      updateSyncStatus('⏳ Loading...', true);
      
      const userDocRef = doc(db, 'users', currentUser.uid);
      const userDoc = await getDoc(userDocRef);
      
      if (userDoc.exists()) {
        const userData = userDoc.data();
        if (userData.folders) {
          folders = userData.folders;
          renderFolders();
          updateFolderSelect();
        }
      }
      
      updateSyncStatus('✓ Loaded', false);
    } catch (error) {
      console.error('Load error:', error);
      updateSyncStatus('⚠️ Load failed', true);
      initializeEmptyData();
    }
  }

  function updateSyncStatus(message, isSyncing = false) {
    const indicator = document.getElementById('syncIndicator');
    const text = document.getElementById('syncText');
    
    text.textContent = message;
    
    if (isSyncing) {
      indicator.className = 'sync-indicator syncing';
    } else if (message.includes('✓')) {
      indicator.className = 'sync-indicator';
    } else if (message.includes('⚠')) {
      indicator.className = 'sync-indicator error';
    } else {
      indicator.className = 'sync-indicator';
    }
  }

  function initializeEmptyData() {
    if (folders.length === 0) {
      folders = [
        {
          id: 'default',
          name: 'All Media',
          items: [],
          subfolders: [],
          collapsed: false
        }
      ];
      saveFolders();
      renderFolders();
      updateFolderSelect();
    }
  }

  function saveFolders() {
    localStorage.setItem('mediaFolders', JSON.stringify(folders));
  }

  function renderFolders() {
    const foldersContainer = document.getElementById('folders');
    foldersContainer.innerHTML = '';
    renderFolderList(folders, foldersContainer);
  }

  function renderFolderList(folderList, container, level = 0) {
    folderList.forEach(folder => {
      const folderElement = document.createElement('div');
      folderElement.className = 'folder-header' + (folder.collapsed ? ' collapsed' : '');
      folderElement.style.marginLeft = level > 0 ? '20px' : '0';
      folderElement.dataset.id = folder.id;
      folderElement.dataset.folderId = folder.id;
      
      folderElement.innerHTML = `
        <div class="icon">${folder.collapsed ? '▶' : '▼'}</div>
        <div class="name">${folder.name}</div>
        <div class="count">${folder.itemCount || 0}</div>
        <div class="folder-actions">
          <button class="ghost btn-sm add-subfolder" data-id="${folder.id}" title="Add subfolder">➕</button>
          <button class="ghost btn-sm collapse" data-id="${folder.id}">${folder.collapsed ? '👁️' : '🙈'}</button>
        </div>
      `;
      
      // Make folder header droppable
      folderElement.addEventListener('dragover', (e) => {
        if (dragState.isDragging) {
          e.preventDefault();
          folderElement.classList.add('drop-target');
        }
      });
      
      folderElement.addEventListener('dragleave', () => {
        folderElement.classList.remove('drop-target');
      });
      
      folderElement.addEventListener('drop', (e) => {
        e.preventDefault();
        folderElement.classList.remove('drop-target');
        if (dragState.isDragging && dragState.sourceFolderId !== folder.id) {
          moveMedia(dragState.draggedItem, folder.id);
        }
      });
      
      // Toggle collapse/expand
      folderElement.querySelector('.icon').addEventListener('click', function(e) {
        e.stopPropagation();
        folder.collapsed = !folder.collapsed;
        saveFolders();
        renderFolders();
      });
      
      // Add subfolder
      folderElement.querySelector('.add-subfolder').addEventListener('click', function(e) {
        e.stopPropagation();
        const subfolderName = prompt('Enter subfolder name:');
        if (subfolderName) {
          addFolder(subfolderName, folder.id);
        }
      });
      
      container.appendChild(folderElement);
      
      // Folder content
      const folderContent = document.createElement('div');
      folderContent.className = 'folder-content' + (folder.collapsed ? ' collapsed' : '');
      
      if (!folder.collapsed) {
        // Render subfolders
        if (folder.subfolders && folder.subfolders.length > 0) {
          renderFolderList(folder.subfolders, folderContent, level + 1);
        }
        
        // Render items
        if (folder.items && folder.items.length > 0) {
          const videoList = document.createElement('div');
          videoList.className = 'videoList';
          folder.items.forEach(item => {
            const itemElement = createMediaItemElement(item, folder.id);
            videoList.appendChild(itemElement);
          });
          folderContent.appendChild(videoList);
        } else if (!folder.subfolders || folder.subfolders.length === 0) {
          folderContent.innerHTML = `
            <div class="small" style="text-align:center;padding:10px;color:var(--muted)">
              No media in this folder. Drag and drop files here.
            </div>
          `;
        }
      }
      
      container.appendChild(folderContent);
    });
  }

  function createMediaItemElement(item, folderId) {
    const itemElement = document.createElement('div');
    itemElement.className = 'vitem';
    itemElement.dataset.id = item.id;
    itemElement.dataset.folderId = folderId;
    itemElement.draggable = true;
    
    itemElement.addEventListener('dragstart', (e) => {
      handleDragStart(e, item.id, folderId);
    });
    
    const isVideo = item.type === 'video';
    const thumbSrc = item.thumb || (isVideo ? 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjcyIiB2aWV3Qm94PSIwIDAgMTIwIDcyIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iNzIiIGZpbGw9IiMyRjJGMkYiLz48cGF0aCBkPSJNNTAuNSAzNkw0NSAzMi42N1YzOS4zM0w1MC41IDM2WiIgZmlsbD0iI0ZGRiIvPjwvc3ZnPg==' : 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjcyIiB2aWV3Qm94PSIwIDAgMTIwIDcyIiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iNzIiIGZpbGw9IiMyRjJGMkYiLz48Y2lyY2xlIGN4PSI2MCIgY3k9IjM2IiByPSIxOCIgZmlsbD0iI0ZGRiIvPjwvc3ZnPg==');
    
    itemElement.innerHTML = `
      <div class="thumb">
        <img src="${thumbSrc}" alt="${item.title || 'Media'}" draggable="false">
      </div>
      <div class="meta">
        <h3>${item.title || 'Untitled'}</h3>
        <p>${item.duration || ''} ${item.size || ''}</p>
      </div>
      <span class="media-type-badge ${isVideo ? 'media-type-video' : 'media-type-photo'}">${isVideo ? '🎥' : '📷'}</span>
    `;
    
    // Click to view media
    itemElement.addEventListener('click', function() {
      viewMedia(item, folderId);
    });
    
    return itemElement;
  }

  function addFolder(name, parentId = null) {
    const newFolder = {
      id: 'folder_' + Date.now(),
      name: name,
      items: [],
      subfolders: [],
      collapsed: false,
      itemCount: 0
    };
    
    if (parentId) {
      const parentFolder = findFolderById(parentId);
      if (parentFolder) {
        if (!parentFolder.subfolders) parentFolder.subfolders = [];
        parentFolder.subfolders.push(newFolder);
      }
    } else {
      folders.push(newFolder);
    }
    
    saveFolders();
    renderFolders();
    updateFolderSelect();
    syncDataToFirebase();
  }

  function findFolderById(folderId) {
    function searchFolder(folder) {
      if (folder.id === folderId) return folder;
      if (folder.subfolders) {
        for (const subfolder of folder.subfolders) {
          const found = searchFolder(subfolder);
          if (found) return found;
        }
      }
      return null;
    }
    
    for (const folder of folders) {
      const found = searchFolder(folder);
      if (found) return found;
    }
    return null;
  }

  function updateFolderSelect() {
    const folderSelect = document.getElementById('folderSelect');
    folderSelect.innerHTML = '<option value="">Select folder...</option>';
    
    function addFoldersToSelect(folderList, level = 0) {
      folderList.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.id;
        option.textContent = '  '.repeat(level) + folder.name;
        folderSelect.appendChild(option);
        
        if (folder.subfolders && folder.subfolders.length > 0) {
          addFoldersToSelect(folder.subfolders, level + 1);
        }
      });
    }
    
    addFoldersToSelect(folders);
  }

  // ========== DRAG AND DROP FUNCTIONS ==========
  function initializeDragAndDrop() {
    document.addEventListener('dragover', handleDragOver);
    document.addEventListener('drop', handleDrop);
    document.addEventListener('dragend', handleDragEnd);
  }

  function handleDragStart(e, itemId, folderId) {
    dragState.isDragging = true;
    dragState.draggedItem = itemId;
    dragState.sourceFolderId = folderId;
    dragState.draggedItemElement = e.target.closest('.vitem');
    
    if (dragState.draggedItemElement) {
      dragState.draggedItemElement.classList.add('dragging');
    }
    
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', itemId);
  }

  function handleDragOver(e) {
    if (!dragState.isDragging) return;
    
    e.preventDefault();
    const dropTarget = findDropTarget(e.target);
    
    // Remove previous drop targets
    document.querySelectorAll('.drop-target').forEach(el => {
      el.classList.remove('drop-target');
    });
    
    if (dropTarget) {
      dropTarget.classList.add('drop-target');
      e.dataTransfer.dropEffect = 'move';
    }
  }

  function handleDrop(e) {
    e.preventDefault();
    
    if (!dragState.isDragging) return;
    
    const dropTarget = findDropTarget(e.target);
    if (dropTarget && dropTarget.dataset.folderId) {
      const targetFolderId = dropTarget.dataset.folderId;
      if (targetFolderId !== dragState.sourceFolderId) {
        moveMedia(dragState.draggedItem, targetFolderId);
      }
    }
    
    // Clean up
    document.querySelectorAll('.drop-target').forEach(el => {
      el.classList.remove('drop-target');
    });
    
    if (dragState.draggedItemElement) {
      dragState.draggedItemElement.classList.remove('dragging');
    }
    
    resetDragState();
  }

  function handleDragEnd() {
    document.querySelectorAll('.drop-target').forEach(el => {
      el.classList.remove('drop-target');
    });
    
    if (dragState.draggedItemElement) {
      dragState.draggedItemElement.classList.remove('dragging');
    }
    
    resetDragState();
  }

  function findDropTarget(element) {
    let current = element;
    while (current && current !== document) {
      if (current.classList.contains('folder-header') || current.classList.contains('vitem')) {
        return current;
      }
      current = current.parentElement;
    }
    return null;
  }

  function resetDragState() {
    dragState.isDragging = false;
    dragState.draggedItem = null;
    dragState.sourceFolderId = null;
    dragState.draggedItemElement = null;
  }

  function moveMedia(itemId, targetFolderId) {
    const itemInfo = findItemInFolders(itemId);
    if (!itemInfo) return;
    
    const { folder: sourceFolder, item } = itemInfo;
    const targetFolder = findFolderById(targetFolderId);
    
    if (!targetFolder || sourceFolder.id === targetFolder.id) return;
    
    // Remove from source folder
    const itemIndex = sourceFolder.items.findIndex(item => item.id === itemId);
    if (itemIndex !== -1) {
      sourceFolder.items.splice(itemIndex, 1);
      sourceFolder.itemCount = sourceFolder.items.length;
    }
    
    // Add to target folder
    if (!targetFolder.items) targetFolder.items = [];
    targetFolder.items.push(item);
    targetFolder.itemCount = targetFolder.items.length;
    
    saveFolders();
    renderFolders();
    syncDataToFirebase();
  }

  function findItemInFolders(itemId) {
    function searchFolder(folder) {
      if (folder.items) {
        const item = folder.items.find(item => item.id === itemId);
        if (item) return { folder, item };
      }
      
      if (folder.subfolders) {
        for (const subfolder of folder.subfolders) {
          const result = searchFolder(subfolder);
          if (result) return result;
        }
      }
      return null;
    }
    
    for (const folder of folders) {
      const result = searchFolder(folder);
      if (result) return result;
    }
    return null;
  }

  // ========== MEDIA VIEWER FUNCTIONS ==========
  function viewMedia(item, folderId) {
    document.getElementById('emptyMain').style.display = 'none';
    document.getElementById('viewerArea').style.display = 'block';
    
    const player = document.getElementById('player');
    const photoViewer = document.getElementById('photoViewer');
    const titleInput = document.getElementById('titleInput');
    const notesInput = document.getElementById('notesInput');
    const folderSelect = document.getElementById('folderSelect');
    
    // Set media data
    titleInput.value = item.title || '';
    notesInput.value = item.notes || '';
    folderSelect.value = folderId || '';
    
    // Show appropriate media type
    if (item.type === 'video') {
      player.style.display = 'block';
      photoViewer.style.display = 'none';
      player.src = item.url;
    } else {
      player.style.display = 'none';
      photoViewer.style.display = 'block';
      photoViewer.src = item.url;
    }
    
    // Set up save button
    const saveBtn = document.getElementById('saveMeta');
    saveBtn.onclick = function() {
      saveMediaMetadata(item.id, {
        title: titleInput.value,
        notes: notesInput.value,
        folderId: folderSelect.value
      });
    };
    
    // Set up delete button
    const deleteBtn = document.getElementById('deleteBtn');
    deleteBtn.onclick = function() {
      deleteMedia(item.id);
    };
  }

  async function saveMediaMetadata(itemId, metadata) {
    const itemInfo = findItemInFolders(itemId);
    if (!itemInfo) return;
    
    const { folder, item } = itemInfo;
    
    // Update item metadata
    if (metadata.title) item.title = metadata.title;
    if (metadata.notes) item.notes = metadata.notes;
    
    // Move to different folder if specified
    if (metadata.folderId && metadata.folderId !== folder.id) {
      moveMedia(itemId, metadata.folderId);
    } else {
      saveFolders();
      renderFolders();
      syncDataToFirebase();
    }
  }

  async function deleteMedia(itemId) {
    const confirmed = await showModal(
      'Delete Media',
      'Are you sure you want to delete this media item? This action cannot be undone.'
    );
    
    if (!confirmed) return;
    
    const itemInfo = findItemInFolders(itemId);
    if (!itemInfo) return;
    
    const { folder, item } = itemInfo;
    
    // Remove the item
    const itemIndex = folder.items.findIndex(item => item.id === itemId);
    if (itemIndex !== -1) {
      folder.items.splice(itemIndex, 1);
      folder.itemCount = folder.items.length;
    }
    
    // Save and render
    saveFolders();
    renderFolders();
    syncDataToFirebase();
    
    // Hide viewer if the deleted item was being viewed
    document.getElementById('emptyMain').style.display = 'block';
    document.getElementById('viewerArea').style.display = 'none';
  }

  // ========== FILE UPLOAD FUNCTIONS ==========
  function setupEventListeners() {
    // Add folder button
    document.getElementById('addFolderBtn').addEventListener('click', function() {
      const folderName = document.getElementById('newFolderName').value.trim();
      if (folderName) {
        addFolder(folderName);
        document.getElementById('newFolderName').value = '';
      }
    });
    
    // File input handlers
    document.getElementById('fileInputVideo').addEventListener('change', handleFileSelect);
    document.getElementById('fileInputPhoto').addEventListener('change', handleFileSelect);
    document.getElementById('fileInputVideoMobile').addEventListener('change', handleFileSelect);
    document.getElementById('fileInputPhotoMobile').addEventListener('change', handleFileSelect);
    document.getElementById('folderInput').addEventListener('change', handleFolderUpload);
    document.getElementById('folderInputMobile').addEventListener('change', handleFolderUpload);
    
    // Button click handlers
    document.getElementById('addVideoBtn').addEventListener('click', function() {
      document.getElementById('fileInputVideo').click();
    });
    document.getElementById('addPhotoBtn').addEventListener('click', function() {
      document.getElementById('fileInputPhoto').click();
    });
    document.getElementById('addVideoBtnMobile').addEventListener('click', function() {
      document.getElementById('fileInputVideoMobile').click();
    });
    document.getElementById('addPhotoBtnMobile').addEventListener('click', function() {
      document.getElementById('fileInputPhotoMobile').click();
    });
    
    // Sync buttons
    document.getElementById('syncBtn').addEventListener('click', syncDataToFirebase);
    document.getElementById('syncBtnMobile').addEventListener('click', syncDataToFirebase);
    
    // Export/Import
    document.getElementById('exportBtn2').addEventListener('click', exportLibrary);
    document.getElementById('importInput2').addEventListener('change', handleImport);
    document.getElementById('importBtn2').addEventListener('click', function() {
      document.getElementById('importInput2').click();
    });
  }

  async function handleFileSelect(e) {
    const files = Array.from(e.target.files);
    await processFileUpload(files);
    e.target.value = '';
  }

  async function handleFolderUpload(e) {
    const files = Array.from(e.target.files);
    await processFileUpload(files);
    e.target.value = '';
  }

  async function processFileUpload(files) {
    if (files.length === 0) return;
    
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const duplicateWarning = document.getElementById('duplicateWarning');
    
    uploadProgress.style.display = 'block';
    duplicateWarning.style.display = 'none';
    
    let uploadedCount = 0;
    let duplicateCount = 0;
    
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const progress = ((i + 1) / files.length) * 100;
      
      progressFill.style.width = `${progress}%`;
      progressText.textContent = `${i + 1}/${files.length} files`;
      
      try {
        const isDuplicate = await checkDuplicate(file);
        if (isDuplicate) {
          duplicateCount++;
          continue;
        }
        
        await processSingleFile(file);
        uploadedCount++;
      } catch (error) {
        console.error('Error processing file:', error);
      }
    }
    
    // Show duplicate warning if any duplicates were found
    if (duplicateCount > 0) {
      duplicateWarning.style.display = 'block';
      document.getElementById('duplicateCount').textContent = duplicateCount;
    }
    
    // Update progress to show completion
    progressFill.style.width = '100%';
    progressText.textContent = `Uploaded ${uploadedCount} files`;
    
    // Hide progress after delay
    setTimeout(() => {
      uploadProgress.style.display = 'none';
    }, 3000);
  }

  async function processSingleFile(file) {
    return new Promise((resolve, reject) => {
      // Create a unique ID for the file
      const fileId = 'media_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      
      // Determine file type
      const isVideo = file.type.startsWith('video/');
      const isImage = file.type.startsWith('image/');
      
      if (!isVideo && !isImage) {
        reject(new Error('Unsupported file type'));
        return;
      }
      
      const mediaItem = {
        id: fileId,
        type: isVideo ? 'video' : 'photo',
        title: file.name,
        file: file,
        size: formatFileSize(file.size),
        uploadDate: new Date().toISOString()
      };
      
      // For videos, try to generate duration and thumbnail
      if (isVideo) {
        generateVideoThumbnail(file).then(thumbData => {
          mediaItem.thumb = thumbData;
          mediaItem.duration = '0:00'; // Placeholder
          addMediaToFolder(mediaItem);
          resolve(mediaItem);
        }).catch(error => {
          console.error('Error generating thumbnail:', error);
          addMediaToFolder(mediaItem);
          resolve(mediaItem);
        });
      } else {
        // For images, create thumbnail from the image itself
        createImageThumbnail(file).then(thumbData => {
          mediaItem.thumb = thumbData;
          addMediaToFolder(mediaItem);
          resolve(mediaItem);
        }).catch(error => {
          console.error('Error creating image thumbnail:', error);
          addMediaToFolder(mediaItem);
          resolve(mediaItem);
        });
      }
    });
  }

  function addMediaToFolder(mediaItem) {
    // Add to the first folder (or a default folder)
    if (folders.length === 0) {
      initializeEmptyData();
    }
    
    const targetFolder = folders[0]; // Add to first folder
    if (!targetFolder.items) targetFolder.items = [];
    targetFolder.items.push(mediaItem);
    targetFolder.itemCount = targetFolder.items.length;
    
    saveFolders();
    renderFolders();
    syncDataToFirebase();
  }

  function generateVideoThumbnail(file) {
    return new Promise((resolve, reject) => {
      const video = document.createElement('video');
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      video.addEventListener('loadeddata', function() {
        video.currentTime = 1; // Seek to 1 second
      });
      
      video.addEventListener('seeked', function() {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        resolve(canvas.toDataURL());
      });
      
      video.addEventListener('error', reject);
      
      video.src = URL.createObjectURL(file);
    });
  }

  function createImageThumbnail(file) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      img.onload = function() {
        // Calculate dimensions for thumbnail
        const maxWidth = 120;
        const maxHeight = 72;
        let { width, height } = img;
        
        if (width > height) {
          if (width > maxWidth) {
            height *= maxWidth / width;
            width = maxWidth;
          }
        } else {
          if (height > maxHeight) {
            width *= maxHeight / height;
            height = maxHeight;
          }
        }
        
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        resolve(canvas.toDataURL());
      };
      
      img.onerror = reject;
      img.src = URL.createObjectURL(file);
    });
  }

  async function checkDuplicate(file) {
    // Simple duplicate check based on file name and size
    for (const folder of folders) {
      if (folder.items) {
        for (const item of folder.items) {
          if (item.title === file.name && item.size === formatFileSize(file.size)) {
            return true;
          }
        }
      }
    }
    return false;
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  // ========== EXPORT/IMPORT FUNCTIONS ==========
  function exportLibrary() {
    const dataStr = JSON.stringify({ folders: folders }, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'mediatracker-backup-' + new Date().toISOString().split('T')[0] + '.json';
    link.click();
  }

  async function handleImport(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const confirmed = await showModal(
      'Import Library',
      'This will replace your current library. Are you sure you want to continue?'
    );
    
    if (!confirmed) {
      e.target.value = '';
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(event) {
      try {
        const importedData = JSON.parse(event.target.result);
        
        if (importedData.folders && Array.isArray(importedData.folders)) {
          folders = importedData.folders;
          saveFolders();
          renderFolders();
          syncDataToFirebase();
          
          showModal('Success', 'Library imported successfully!');
        } else {
          showModal('Error', 'Invalid library file format.');
        }
      } catch (error) {
        console.error('Import error:', error);
        showModal('Error', 'Error importing library file.');
      }
    };
    
    reader.readAsText(file);
    e.target.value = '';
  }

  // ========== MODAL SYSTEM ==========
  function showModal(title, message) {
    return new Promise((resolve) => {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = message;
      const modal = document.getElementById('customModal');
      modal.classList.add('show');

      const confirmBtn = document.getElementById('modalConfirm');
      const cancelBtn = document.getElementById('modalCancel');

      const cleanup = () => {
        modal.classList.remove('show');
        confirmBtn.onclick = null;
        cancelBtn.onclick = null;
      };

      confirmBtn.onclick = () => {
        cleanup();
        resolve(true);
      };

      cancelBtn.onclick = () => {
        cleanup();
        resolve(false);
      };
    });
  }

  // ========== PWA FUNCTIONS ==========
  function initializePWA() {
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(function(registration) {
        console.log('SW registered: ', registration);
      }).catch(function(registrationError) {
        console.log('SW registration failed: ', registrationError);
      });
    }

    // Listen for before install prompt
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      showInstallPrompt();
    });

    // Install prompt handlers
    document.getElementById('installBtn').addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          hideInstallPrompt();
        }
        deferredPrompt = null;
      }
    });

    document.getElementById('installClose').addEventListener('click', hideInstallPrompt);
  }

  function showInstallPrompt() {
    document.getElementById('installPrompt').classList.add('show');
  }

  function hideInstallPrompt() {
    document.getElementById('installPrompt').classList.remove('show');
  }

  // ========== VIDEO PLAYER FUNCTIONS ==========
  function initializeVideoPlayer() {
    const player = document.getElementById('player');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const progressContainer = document.getElementById('progressContainer');
    const videoProgress = document.getElementById('videoProgress');
    const timeDisplay = document.getElementById('timeDisplay');
    const fullscreenBtn = document.getElementById('fullscreenBtn');

    player.addEventListener('loadedmetadata', () => {
      videoPlayerState.duration = player.duration;
      updateTimeDisplay();
    });

    player.addEventListener('timeupdate', () => {
      videoPlayerState.currentTime = player.currentTime;
      const progress = (player.currentTime / player.duration) * 100;
      videoProgress.style.width = `${progress}%`;
      updateTimeDisplay();
    });

    player.addEventListener('play', () => {
      videoPlayerState.isPlaying = true;
      playPauseBtn.textContent = '⏸️';
    });

    player.addEventListener('pause', () => {
      videoPlayerState.isPlaying = false;
      playPauseBtn.textContent = '⏯️';
    });

    playPauseBtn.addEventListener('click', () => {
      if (player.paused) {
        player.play();
      } else {
        player.pause();
      }
    });

    progressContainer.addEventListener('click', (e) => {
      const rect = progressContainer.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      player.currentTime = percent * player.duration;
    });

    fullscreenBtn.addEventListener('click', () => {
      if (!videoPlayerState.isFullscreen) {
        player.requestFullscreen?.().catch(err => {
          console.log('Fullscreen error:', err);
        });
      } else {
        document.exitFullscreen?.();
      }
    });

    document.addEventListener('fullscreenchange', () => {
      videoPlayerState.isFullscreen = !!document.fullscreenElement;
    });
  }

  function updateTimeDisplay() {
    const timeDisplay = document.getElementById('timeDisplay');
    const currentTime = formatTime(videoPlayerState.currentTime);
    const duration = formatTime(videoPlayerState.duration);
    timeDisplay.textContent = `${currentTime} / ${duration}`;
  }

  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
  }

  // ========== CONTEXT MENU FUNCTIONS ==========
  function initializeContextMenu() {
    const contextMenu = document.getElementById('contextMenu');
    
    document.addEventListener('contextmenu', (e) => {
      const folderHeader = e.target.closest('.folder-header');
      if (folderHeader) {
        e.preventDefault();
        
        const folderId = folderHeader.dataset.id;
        contextMenu.dataset.folderId = folderId;
        
        contextMenu.style.left = `${e.pageX}px`;
        contextMenu.style.top = `${e.pageY}px`;
        contextMenu.classList.add('show');
      }
    });
    
    document.addEventListener('click', () => {
      contextMenu.classList.remove('show');
    });
    
    // Context menu actions
    contextMenu.querySelectorAll('.context-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const action = e.target.dataset.action;
        const folderId = contextMenu.dataset.folderId;
        
        switch(action) {
          case 'rename':
            renameFolder(folderId);
            break;
          case 'delete-folder':
            deleteFolder(folderId);
            break;
          case 'add-subfolder':
            addSubfolder(folderId);
            break;
        }
        
        contextMenu.classList.remove('show');
      });
    });
  }

  async function deleteFolder(folderId) {
    const folder = findFolderById(folderId);
    if (!folder) return;
    
    const itemCount = getAllItemsInFolder(folder);
    const message = itemCount > 0 
      ? `This will delete "${folder.name}" and its ${itemCount} item(s). This action cannot be undone.`
      : `Delete folder "${folder.name}"?`;
    
    const confirmed = await showModal('Delete Folder', message);
    if (!confirmed) return;
    
    // Remove folder and all its contents
    removeFolderById(folderId);
    saveFolders();
    renderFolders();
    syncDataToFirebase();
  }

  function getAllItemsInFolder(folder) {
    let count = folder.items ? folder.items.length : 0;
    if (folder.subfolders) {
      folder.subfolders.forEach(subfolder => {
        count += getAllItemsInFolder(subfolder);
      });
    }
    return count;
  }

  function removeFolderById(folderId) {
    function removeFromList(folderList) {
      for (let i = folderList.length - 1; i >= 0; i--) {
        if (folderList[i].id === folderId) {
          folderList.splice(i, 1);
          return true;
        }
        if (folderList[i].subfolders) {
          if (removeFromList(folderList[i].subfolders)) {
            return true;
          }
        }
      }
      return false;
    }
    removeFromList(folders);
  }

  function renameFolder(folderId) {
    const folder = findFolderById(folderId);
    if (!folder) return;
    
    const newName = prompt('Enter new folder name:', folder.name);
    if (newName && newName.trim() && newName !== folder.name) {
      folder.name = newName.trim();
      saveFolders();
      renderFolders();
      syncDataToFirebase();
    }
  }

  function addSubfolder(parentFolderId) {
    const subfolderName = prompt('Enter subfolder name:');
    if (subfolderName) {
      addFolder(subfolderName, parentFolderId);
    }
  }

  // ========== URL DOWNLOADER FUNCTIONS ==========
  function initializeUrlDownloader() {
    const downloadBtn = document.getElementById('downloadUrlBtn');
    const urlInput = document.getElementById('videoUrl');

    downloadBtn.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      if (!url) {
        showError('Please enter a valid URL');
        return;
      }

      if (!url.match(/\.(mp4|webm|mov)$/i)) {
        const proceed = await showModal(
          'Unsupported Format',
          'This URL might not be a supported video format (MP4, WebM, MOV). Continue anyway?'
        );
        if (!proceed) return;
      }

      try {
        downloadBtn.disabled = true;
        downloadBtn.textContent = '⏳ Downloading...';

        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to download video');

        const blob = await response.blob();
        const fileName = url.split('/').pop() || 'downloaded-video.mp4';
        
        // Create a file from the blob
        const file = new File([blob], fileName, { type: blob.type });
        
        // Process the downloaded file
        await processSingleFile(file);
        
        urlInput.value = '';
        showError(''); // Clear any previous errors
        
      } catch (error) {
        console.error('URL download error:', error);
        showError('Failed to download video from URL');
      } finally {
        downloadBtn.disabled = false;
        downloadBtn.textContent = '📥 Download';
      }
    });
  }

  // ========== CONVERSION TOOLS FUNCTIONS ==========
  function initializeConversionTools() {
    const conversionOptions = document.querySelectorAll('.conversion-option');
    
    conversionOptions.forEach(option => {
      option.addEventListener('click', function() {
        const conversionType = this.dataset.convert;
        handleConversion(conversionType);
      });
    });
  }

  function handleConversion(type) {
    const currentItem = getCurrentMediaItem();
    if (!currentItem) {
      showError('Please select a media item first');
      return;
    }

    switch(type) {
      case 'compress':
        showModal('Compress Video', 'This feature will compress your video to reduce file size. Coming soon!');
        break;
      case 'format':
        showModal('Convert Format', 'Convert your video to different formats (MP4, WebM, etc.). Coming soon!');
        break;
      case 'resolution':
        showModal('Change Resolution', 'Adjust video resolution (1080p, 720p, 480p). Coming soon!');
        break;
      case 'trim':
        showModal('Trim Video', 'Trim your video to select specific parts. Coming soon!');
        break;
    }
  }

  function getCurrentMediaItem() {
    // This would return the currently selected media item
    // Implementation depends on your current selection system
    return null;
  }

  // ========== CLOUD STORAGE FUNCTIONS ==========
  function initializeCloudStorage() {
    // Cloud storage dropdown toggle
    document.getElementById('cloudStorageBtn').addEventListener('click', function() {
      document.getElementById('cloudDropdown').classList.toggle('show');
    });

    // Cloud provider selection
    document.querySelectorAll('.cloud-option').forEach(option => {
      option.addEventListener('click', function() {
        const provider = this.dataset.provider;
        selectCloudProvider(provider);
        document.getElementById('cloudDropdown').classList.remove('show');
      });
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.cloud-storage-dropdown')) {
        document.getElementById('cloudDropdown').classList.remove('show');
      }
    });
  }

  function selectCloudProvider(provider) {
    currentCloudProvider = provider;
    document.getElementById('cloudBrowser').classList.add('show');
    
    // Show provider-specific content
    const cloudContent = document.getElementById('cloudContent');
    cloudContent.innerHTML = `
      <div class="small" style="text-align:center;padding:20px;color:var(--muted)">
        Connecting to ${provider}...
      </div>
    `;
    
    // In a real implementation, you would:
    // 1. Authenticate with the cloud provider
    // 2. Fetch the user's files
    // 3. Display them in the cloud browser
  }

  // ========== APP INITIALIZATION ==========
  function initializeApp() {
    // Initialize theme
    const themeBtn = document.getElementById('themeBtn');
    const body = document.body;
    
    const savedTheme = localStorage.getItem('theme') || 
      (window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark');
    
    if (savedTheme === 'light') {
      body.classList.add('light');
    }
    
    themeBtn.addEventListener('click', function() {
      body.classList.toggle('light');
      const isLight = body.classList.contains('light');
      localStorage.setItem('theme', isLight ? 'light' : 'dark');
    });
    
    // Initialize all features
    initializePWA();
    initializeVideoPlayer();
    initializeUrlDownloader();
    initializeConversionTools();
    initializeDragAndDrop();
    initializeContextMenu();
    initializeCloudStorage();
    
    // Initialize empty structure
    initializeEmptyData();
    
    // Set up event listeners for other UI elements
    setupEventListeners();
  }

  // Initialize the app when DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing app');
    
    // Set up authentication event listeners
    setupAuthEventListeners();
    
    // Set up sign out button - FIXED
document.getElementById('signOutBtn').addEventListener('click', signOutUser);
  });

</script>

<!-- Cloud Storage SDKs -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="iy5lgx8guukd2q3"></script>
<script src="https://cdn.jsdelivr.net/npm/mega@6.0.0/dist/mega.js"></script>
</body>
</html>