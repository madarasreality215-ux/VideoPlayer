<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ“± MediaTracker Pro â€” Offline</title>
<meta name="theme-color" content="#7c3aed">
<link rel="preconnect" href="https://fixupx.com">
<!-- WebTorrent & JSZip (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/webtorrent@latest/webtorrent.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  :root{
    --bg:#0b1220;
    --card:#0f1724;
    --text:#e6eef9;
    --muted:rgba(230,238,249,0.65);
    --accent:#7c3aed;
    --accent-hover:#6d28d9;
    --green:#10b981;
    --card-border: rgba(255,255,255,0.08);
    --card-shadow: 0 10px 25px rgba(0,0,0,0.28);
    --radius: 14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  a{color:inherit;text-decoration:none}
  /* Header */
  header{display:flex;align-items:center;gap:12px;justify-content:space-between;background:var(--card);padding:12px 16px;position:sticky;top:0;z-index:10;border-bottom:1px solid var(--card-border)}
  h1{margin:0;font-size:18px;font-weight:700}
  .ghost{background:transparent;border:1px solid var(--card-border);padding:8px 10px;border-radius:10px;cursor:pointer}
  .ghost:hover{background:rgba(255,255,255,0.06)}
  /* Layout */
  .container{display:grid;grid-template-columns:340px 1fr;gap:16px;padding:16px;min-height:calc(100vh - 60px)}
  @media (max-width:1024px){.container{grid-template-columns:1fr}}
  /* Cards */
  .card{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);box-shadow:var(--card-shadow);padding:14px}
  .card h3{margin:0 0 10px 0;font-size:14px;color:var(--accent);display:flex;align-items:center;gap:8px}
  /* Sidebar */
  .sidebar{display:flex;flex-direction:column;gap:16px}
  .btn{background:var(--accent);color:#fff;border:none;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn:hover{background:var(--accent-hover)}
  .btn-green{background:var(--green)}
  .btn-row{display:flex;gap:8px}
  .input, select{width:100%;padding:10px;border-radius:10px;border:1px solid var(--card-border);background:transparent;color:var(--text)}
  .small{font-size:12px;color:var(--muted)}
  /* Folder sections */
  .folders-empty{color:var(--muted);text-align:center;padding:10px}
  .folder-section{border:1px dashed var(--card-border);border-radius:12px;background:rgba(255,255,255,0.02);margin-top:8px}
  .folder-header{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:10px 12px;cursor:pointer;border-radius:12px}
  .folder-left{display:flex;align-items:center;gap:8px;min-width:0}
  .chev{transition:transform .2s}
  .folder-header.collapsed .chev{transform:rotate(-90deg)}
  .folder-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .folder-actions{display:flex;gap:6px}
  .action{background:transparent;border:1px solid var(--card-border);color:inherit;border-radius:8px;padding:4px 8px;cursor:pointer;font-size:12px}
  .action:hover{background:rgba(255,255,255,0.06)}
  .folder-content{overflow:hidden;max-height:0;transition:max-height .25s ease,padding .25s ease;padding:0 12px}
  .folder-content.open{padding:8px 12px 12px 44px}
  .vlist{display:flex;flex-direction:column;gap:8px}
  .vitem{display:flex;gap:10px;align-items:center;background:rgba(255,255,255,0.04);border-radius:10px;padding:8px;cursor:pointer}
  .vitem:hover{background:rgba(255,255,255,0.06)}
  .thumb{width:120px;height:72px;background:#000;border-radius:8px;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#aaa}
  .thumb video,.thumb img{width:100%;height:100%;object-fit:cover}
  .meta{min-width:0;flex:1}
  .meta h4{margin:0;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .badge{font-size:10px;background:var(--accent);color:#fff;border-radius:999px;padding:2px 8px;margin-left:6px}
  /* Main */
  .main{background:var(--card);border:1px solid var(--card-border);border-radius:var(--radius);box-shadow:var(--card-shadow);padding:12px}
  .topbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .search{flex:1;position:relative}
  .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--card-border);background:transparent;color:var(--text)}
  .sort{border:1px solid var(--card-border);border-radius:10px;padding:10px 12px;cursor:pointer}
  .empty{display:flex;align-items:center;justify-content:center;min-height:60vh;color:var(--muted);font-size:16px}
  /* Viewer */
  .viewer{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:9999}
  .viewer.show{display:flex}
  .viewer video{max-width:92vw;max-height:92vh;border-radius:12px}
  /* Torrent preview grid */
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(90px,1fr));gap:8px}
  .thumb-sm{width:100%;aspect-ratio:1;border-radius:8px;object-fit:cover;background:#000}
  .progress{height:8px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden}
  .progress > span{display:block;height:100%;background:var(--accent);width:0%}
  .row{display:flex;gap:8px;align-items:center}

  /* Sort and Sign Out button restyle */
  #sortBtn, header .ghost {
    background: var(--card);
    border: 1px solid var(--card-border);
    border-radius: 10px;
    padding: 10px 14px;
    font-weight: 600;
    transition: all .25s ease;
  }
  #sortBtn {
    color: var(--muted);
  }
  header .ghost {
    color: #fff;
  }
  #sortBtn:hover, header .ghost:hover {
    background: rgba(255,255,255,0.08);
  }
</style>
</head>
<body>
  <header>
    <h1>ğŸ“± MediaTracker Pro (Offline)</h1>
    <a class="ghost" href="login.html">ğŸšª Sign Out</a>
  </header>

  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
<!-- ğŸ“¦ Create Folder -->
      <div class="card">
        <h3>ğŸ“¦ Create Folder</h3>
        <div class="row">
          <input id="newFolderName" class="input" placeholder="New folder name">
          <button id="addFolder" class="btn">ğŸ“ Folders</button>
        </div>
      </div>

      <!--<!-- ğŸ  Main Library -->
      <div class="card">
        <h3>ğŸ  Main Library</h3>
        <div id="foldersEmpty" class="folders-empty" style="display:none">No folders yet. Create one below!</div>
        <div id="foldersContainer"></div>
      </div>

      <!--
      <!-- ğŸ  Main Library -->

      <div class="card">
        <h3>â• Add Media</h3>
        <div class="btn-row">
          <input id="videoInput" type="file" accept="video/*" multiple style="display:none">
          <button id="addVideos" class="btn" style="flex:1">ğŸ¥ Add Videos</button>
          <input id="photoInput" type="file" accept="image/*" multiple style="display:none">
          <button id="addPhotos" class="btn btn-green" style="flex:1">ğŸ“· Add Photos</button>
        </div>
        <div class="small" style="margin-top:6px;text-align:center">Supports MP4, WebM, MOV, JPG, PNG, GIF</div>
      </div>

      <!-- ğŸ¦ Twitter / X Downloader (FixTweet) -->
      <div class="card">
        <h3>ğŸ¦ Twitter/X Downloader</h3>
        <input id="tweetUrl" class="input" placeholder="Paste Twitter/X URL here">
        <button id="fetchTweet" class="btn" style="width:100%;margin-top:8px">Fetch Twitter Media</button>
        <div id="tweetPreview" class="card" style="margin-top:10px;display:none;padding:10px">
          <h3 style="margin-bottom:8px">ğŸï¸ Preview</h3>
          <div id="tweetMediaBox" style="text-align:center"></div>
          <button id="saveFromTweet" class="btn" style="width:100%;margin-top:10px">â¬‡ï¸ Download to Library</button>
        </div>
      </div>

      <!-- ğŸŒ€ Torrent Downloader (WebTorrent + JSZip) -->
      <div class="card">
        <h3>ğŸŒ€ Torrent Downloader</h3>
        <input id="magnetInput" class="input" placeholder="Paste magnet link (photo ZIP torrents)">
        <div class="btn-row" style="margin-top:8px">
          <input id="torrentFile" type="file" accept=".torrent" style="display:none">
          <button id="chooseTorrent" class="btn" style="flex:1">ğŸ“‚ Choose .torrent</button>
          <button id="startTorrent" class="btn" style="flex:1">â–¶ï¸ Start Torrent</button>
        </div>
        <div id="torrentStatus" class="small" style="margin-top:8px;color:#cbd5e1"></div>
        <div class="progress" style="margin-top:6px"><span id="torrentBar"></span></div>

        <!-- ZIP extraction + image preview -->
        <div id="zipStatus" class="small" style="margin-top:10px;display:none">ğŸ—œï¸ ZIP detected: extracting photos...</div>
        <div id="zipGrid" class="grid" style="margin-top:10px"></div>
        <button id="saveFromTorrent" class="btn" style="width:100%;margin-top:10px;display:none">â¬‡ï¸ Add Extracted Photos to Library</button>
      </div>
    </div>

    <!-- Main -->
    <div class="main">
      <div class="topbar">
        <div class="search"><input id="search" placeholder="ğŸ” Search videos..."></div>
        <button id="sortBtn" class="ghost">ğŸ“… Sort: Newest</button>
      </div>
      <div id="mainEmpty" class="empty">No media yet. Add some videos or photos to get started!</div>
      <div id="mainList" style="display:none"></div>
    </div>
  </div>

  <!-- Fullscreen viewer -->
  <div id="viewer" class="viewer"><video id="viewerVideo" controls autoplay muted></video></div>

  <!-- Modal (rename / confirm) -->
  <div id="modalOverlay" class="viewer" style="background:rgba(0,0,0,.78);">
    <div class="card" style="max-width:440px;width:92%">
      <h3 id="modalTitle">Rename Folder</h3>
      <div id="modalBody">
        <input id="modalInput" class="input" placeholder="Enter new name">
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="modalCancel" class="ghost">Cancel</button>
        <button id="modalOK" class="btn">OK</button>
      </div>
    </div>
  </div>

<script>
// ===== State (localStorage) =====
const LS_KEY = 'mtp_offline_v5';
let state = { folders: [], media: {}, collapse: {}, sort: 'newest' };
const uid = p => p+'_'+Date.now()+'_'+Math.random().toString(36).slice(2,9);
const save = ()=> localStorage.setItem(LS_KEY, JSON.stringify(state));
const load = ()=>{ try{ const s=JSON.parse(localStorage.getItem(LS_KEY)||'{}'); state = Object.assign(state,s);}catch{} };
load();

// ===== DOM =====
const foldersContainer = document.getElementById('foldersContainer');
const foldersEmpty = document.getElementById('foldersEmpty');
const newFolderName = document.getElementById('newFolderName');
const addFolderBtn = document.getElementById('addFolder');

const videoInput = document.getElementById('videoInput');
const addVideos = document.getElementById('addVideos');
const photoInput = document.getElementById('photoInput');
const addPhotos = document.getElementById('addPhotos');

const searchEl = document.getElementById('search');
const mainEmpty = document.getElementById('mainEmpty');
const mainList = document.getElementById('mainList');
const sortBtn = document.getElementById('sortBtn');

const tweetUrl = document.getElementById('tweetUrl');
const fetchTweet = document.getElementById('fetchTweet');
const tweetPreview = document.getElementById('tweetPreview');
const tweetMediaBox = document.getElementById('tweetMediaBox');
const saveFromTweet = document.getElementById('saveFromTweet');

const viewer = document.getElementById('viewer');
const viewerVideo = document.getElementById('viewerVideo');

const modalOverlay = document.getElementById('modalOverlay');
const modalTitle = document.getElementById('modalTitle');
const modalInput = document.getElementById('modalInput');
const modalOK = document.getElementById('modalOK');
const modalCancel = document.getElementById('modalCancel');
let modalCb = null;

// Torrent DOM
const magnetInput = document.getElementById('magnetInput');
const chooseTorrent = document.getElementById('chooseTorrent');
const torrentFile = document.getElementById('torrentFile');
const startTorrent = document.getElementById('startTorrent');
const torrentStatus = document.getElementById('torrentStatus');
const torrentBar = document.getElementById('torrentBar');
const zipStatus = document.getElementById('zipStatus');
const zipGrid = document.getElementById('zipGrid');
const saveFromTorrent = document.getElementById('saveFromTorrent');

function ensureDefaultCollapse(id){ if(state.collapse[id]===undefined){ state.collapse[id]=true; }}

// ===== Rendering =====
function buildTree(pid=''){
  return state.folders.filter(f=> (f.parentId||'')===(pid||'')).map(f=> ({...f, children: buildTree(f.id)}));
}

function renderFolders(){
  const tree = buildTree(''); foldersContainer.innerHTML=''; foldersEmpty.style.display = state.folders.length? 'none':'block'; tree.forEach(node=> appendFolderSection(node,true,foldersContainer));
}

function appendFolderSection(node,isRoot,host){
  ensureDefaultCollapse(node.id);
  const section = document.createElement('div');
  section.className='folder-section';

  const header = document.createElement('div');
  header.className='folder-header'+(state.collapse[node.id]?' collapsed':'');
  header.dataset.id = node.id;

  const left = document.createElement('div'); left.className='folder-left';
  const chev = document.createElement('span'); chev.className='chev'; chev.textContent='â–¾';
  const title = document.createElement('span'); title.className='folder-title'; title.textContent='ğŸ“ '+node.name;
  left.append(chev,title);

  const actions = document.createElement('div'); actions.className='folder-actions';
  const addSub = document.createElement('button'); addSub.className='action'; addSub.textContent='â• Sub';
  addSub.onclick = (e)=>{ e.stopPropagation(); openRename('Create subfolder', '', val=>{ if(!val.trim())return; const f={id:uid('fld'),name:val.trim(),parentId:node.id}; state.folders.push(f); ensureDefaultCollapse(f.id); save(); renderFolders(); }); };
  actions.appendChild(addSub);
  if(!isRoot){
    const ren = document.createElement('button'); ren.className='action'; ren.textContent='âœï¸ Rename';
    ren.onclick = (e)=>{ e.stopPropagation(); openRename('Rename folder', node.name, val=>{ const f=state.folders.find(x=>x.id===node.id); if(f){f.name=val.trim(); save(); renderFolders();}}); };
    const del = document.createElement('button'); del.className='action'; del.textContent='ğŸ—‘ï¸ Delete';
    del.onclick = (e)=>{ e.stopPropagation(); openConfirm('Delete this folder and all its contents?', ()=>{ deleteFolder(node.id); save(); renderFolders(); }); };
    actions.append(ren,del);
  }

  header.append(left,actions);
  section.appendChild(header);

  const content = document.createElement('div');
  content.className='folder-content';
  if(!state.collapse[node.id]) content.classList.add('open');

  const list = document.createElement('div'); list.className='vlist';
  const items = Object.values(state.media).filter(m=> (m.folderId||'')===node.id).sort(sorter());
  const q=(searchEl.value||'').trim().toLowerCase();
  items.filter(m=> (m.name||'').toLowerCase().includes(q)).forEach(m=> list.appendChild(renderItem(m)));
  node.children.forEach(ch=> appendFolderSection(ch,false,list));

  content.appendChild(list);
  section.appendChild(content);

  header.onclick=()=>{
    state.collapse[node.id]=!state.collapse[node.id]; save();
    if(state.collapse[node.id]) content.classList.remove('open'); else content.classList.add('open');
    header.classList.toggle('collapsed', state.collapse[node.id]);
  };

  // Drag target: move media into this folder
  header.addEventListener('dragover', e=>{ e.preventDefault(); header.classList.add('drop-target'); });
  header.addEventListener('dragleave', ()=> header.classList.remove('drop-target'));
  header.addEventListener('drop', e=>{
    e.preventDefault(); header.classList.remove('drop-target');
    const id = e.dataTransfer.getData('text/id'); if(!id) return;
    const m = state.media[id]; if(!m) return;
    m.folderId = node.id; save(); renderFolders(); renderMain();
  });

  host.appendChild(section);
}

function renderMain(){
  const items = Object.values(state.media).sort(sorter());
  const q=(searchEl.value||'').trim().toLowerCase();
  const filtered = items.filter(m=> (m.name||'').toLowerCase().includes(q));
  mainEmpty.style.display = filtered.length? 'none':'flex';
  mainList.style.display = filtered.length? 'block':'none';
  if(!filtered.length){ mainList.innerHTML=''; return; }
  mainList.innerHTML='';
  filtered.forEach(m=> mainList.appendChild(renderItem(m)));
}

function renderItem(m){
  const el=document.createElement('div'); el.className='vitem'; el.draggable=true;
  const th=document.createElement('div'); th.className='thumb';
  if(m.type==='photo'){ const i=new Image(); i.src=m.src; th.appendChild(i); }
  else { const v=document.createElement('video'); v.src=m.src; v.muted=true; v.playsInline=true; th.appendChild(v); }
  const meta=document.createElement('div'); meta.className='meta';
  const h=document.createElement('h4'); h.textContent=m.name||'(untitled)';
  const badge=document.createElement('span'); badge.className='badge'; badge.textContent=(m.type||'').toUpperCase();
  h.appendChild(badge); meta.appendChild(h);
  el.append(th,meta);
  el.onclick=()=> openViewer(m);
  el.addEventListener('dragstart',e=> e.dataTransfer.setData('text/id',m.id));
  return el;
}

// ===== Viewer =====
function openViewer(m){
  if(m.type==='video'){ viewerVideo.src=m.src; viewer.classList.add('show'); }
  else{ const a=document.createElement('a'); a.href=m.src; a.download=m.name||'image'; a.click(); }
}
viewer.onclick=()=>{ viewer.classList.remove('show'); viewerVideo.pause(); };

// ===== Folder CRUD =====
function addFolder(name,parentId=''){
  const f={id:uid('fld'),name:name.trim(),parentId:parentId||''};
  state.folders.push(f); state.collapse[f.id]=true; save(); renderFolders();
}
function deleteFolder(id){
  // delete children recursively
  state.folders.filter(f=>f.parentId===id).forEach(ch=> deleteFolder(ch.id));
  // delete media in folder
  Object.values(state.media).forEach(m=>{ if(m.folderId===id) delete state.media[m.id]; });
  state.folders = state.folders.filter(f=>f.id!==id);
  delete state.collapse[id];
}
function sorter(){ return (a,b)=> state.sort==='newest' ? (b.createdAt||0)-(a.createdAt||0) : (a.createdAt||0)-(b.createdAt||0); }

// ===== Modal helpers =====
function openRename(title,initial,cb){
  modalTitle.textContent=title; modalInput.value=initial||''; modalCb=cb;
  modalOverlay.classList.add('show'); setTimeout(()=>modalInput.focus(),50);
}
function openConfirm(msg,cb){
  modalTitle.textContent='Confirm';
  document.getElementById('modalBody').innerHTML = '<div class="small">'+msg+'</div>';
  modalCb=cb; modalOverlay.classList.add('show');
}
modalOK.onclick=()=>{ if(modalTitle.textContent==='Confirm'){ modalCb&&modalCb(); } else { modalCb&&modalCb(modalInput.value); } modalOverlay.classList.remove('show'); };
modalCancel.onclick=()=> modalOverlay.classList.remove('show');
modalOverlay.addEventListener('click',e=>{ if(e.target===modalOverlay) modalOverlay.classList.remove('show'); });

// ===== Buttons & Events =====
addFolderBtn.onclick=()=>{
  const n=(newFolderName.value||'').trim(); if(!n) return;
  addFolder(n); newFolderName.value='';
};
addVideos.onclick=()=> videoInput.click();
addPhotos.onclick=()=> photoInput.click();
videoInput.onchange = e => {
  for(const f of Array.from(e.target.files||[])){
    const url = URL.createObjectURL(f);
    const id = uid('vid');
    state.media[id] = {id, name:f.name, type:'video', src:url, createdAt:Date.now(), folderId:''};
  }
  save(); renderFolders(); renderMain(); videoInput.value='';
};
photoInput.onchange = e => {
  for(const f of Array.from(e.target.files||[])){
    const url = URL.createObjectURL(f);
    const id = uid('img');
    state.media[id] = {id, name:f.name, type:'photo', src:url, createdAt:Date.now(), folderId:''};
  }
  save(); renderFolders(); renderMain(); photoInput.value='';
};
searchEl.oninput = ()=>{ renderFolders(); renderMain(); };
sortBtn.onclick = ()=>{ state.sort = state.sort==='newest'?'oldest':'newest'; sortBtn.textContent = state.sort==='newest'?'ğŸ“… Sort: Newest':'ğŸ“… Sort: Oldest'; save(); renderFolders(); renderMain(); };

// ===== Twitter (FixTweet) =====
let lastFetched = null;
fetchTweet.onclick = async ()=>{
  const url = (tweetUrl.value||'').trim(); if(!url) return;
  const idMatch = url.match(/status\/(\d+)/); if(!idMatch){ alert('Invalid Twitter/X URL'); return; }
  const tweetId = idMatch[1];
  tweetPreview.style.display='block';
  tweetMediaBox.innerHTML = '<div class="small">â³ Fetching mediaâ€¦</div>';
  try{
    const res = await fetch(`https://fixupx.com/api/tweet/${tweetId}`);
    const data = await res.json();
    const video = data?.media?.videos?.[0]?.url;
    const image = data?.media?.photos?.[0];
    tweetMediaBox.innerHTML = '';
    if(video){
      const v = document.createElement('video'); v.src = video; v.controls=true; v.autoplay=true; v.muted=true; v.style.maxWidth='100%'; v.style.borderRadius='10px';
      tweetMediaBox.appendChild(v); lastFetched = {type:'video', src: video, name: `tweet_${tweetId}.mp4`};
    }else if(image){
      const img = new Image(); img.src=image; img.style.maxWidth='100%'; img.style.borderRadius='10px';
      tweetMediaBox.appendChild(img); lastFetched = {type:'photo', src: image, name: `tweet_${tweetId}.jpg`};
    }else{
      tweetMediaBox.innerHTML = '<div class="small">âš ï¸ No media found in this tweet.</div>'; lastFetched=null;
    }
  }catch(e){
    tweetMediaBox.innerHTML = '<div class="small">âŒ Failed to fetch media.</div>'; lastFetched=null;
  }
};
saveFromTweet.onclick = ()=>{
  if(!lastFetched){ alert('No media to save.'); return; }
  const id = uid(lastFetched.type==='video'?'vid':'img');
  state.media[id] = { id, name:lastFetched.name, type:lastFetched.type, src:lastFetched.src, createdAt:Date.now(), folderId:'' };
  save(); renderFolders(); renderMain();
  tweetPreview.style.display='none'; tweetMediaBox.innerHTML=''; tweetUrl.value='';
};

// ===== Torrent (WebTorrent + JSZip, photo ZIPs) =====
const client = new WebTorrent();
let extractedPhotos = []; // {name, url}

chooseTorrent.onclick = ()=> torrentFile.click();
torrentFile.onchange = ()=>{
  if(torrentFile.files && torrentFile.files[0]){
    startTorrentWithFile(torrentFile.files[0]);
  }
};
startTorrent.onclick = ()=>{
  const magnet = (magnetInput.value||'').trim();
  if(!magnet && !(torrentFile.files && torrentFile.files[0])){
    alert('Paste a magnet link or choose a .torrent file'); return;
  }
  if(magnet) startTorrentWithMagnet(magnet);
};

function startTorrentWithFile(file){
  resetTorrentUI();
  torrentStatus.textContent = 'â³ Adding .torrentâ€¦';
  client.add(file, onTorrent);
}
function startTorrentWithMagnet(magnet){
  resetTorrentUI();
  torrentStatus.textContent = 'â³ Connecting to peersâ€¦';
  client.add(magnet, onTorrent);
}

function onTorrent(torrent){
  torrentStatus.textContent = 'ğŸ” Downloading metadataâ€¦';
  updateProgress(torrent);
  const progressTimer = setInterval(()=> updateProgress(torrent), 500);

  torrent.on('download', ()=> updateProgress(torrent));
  torrent.on('done', ()=>{
    clearInterval(progressTimer);
    updateProgress(torrent,true);
    torrentStatus.textContent = 'âœ… Torrent download complete. Scanning for ZIP filesâ€¦';
    handleZipExtraction(torrent);
  });
}

function updateProgress(torrent, done=false){
  const pct = Math.min(100, Math.max(0, Math.round(torrent.progress*100)));
  torrentBar.style.width = pct + '%';
  torrentStatus.textContent = (done? 'âœ… Completed ' : 'â¬‡ï¸ Downloading ') + pct + '% â€” ' + (torrent.name||'torrent');
}

async function handleZipExtraction(torrent){
  extractedPhotos = [];
  zipStatus.style.display = 'block';
  zipStatus.textContent = 'ğŸ—œï¸ ZIP detected: extracting photos...';
  zipGrid.innerHTML = '';
  saveFromTorrent.style.display = 'none';

  // find all .zip files in torrent
  const zipFiles = torrent.files.filter(f => /\.zip$/i.test(f.name));
  if(zipFiles.length === 0){
    zipStatus.textContent = 'âš ï¸ No ZIP files found in this torrent.';
    return;
  }

  for(const f of zipFiles){
    // Get the ZIP file as a Blob
    const blob = await new Promise((resolve,reject)=>{
      f.getBlob((err, b)=> err?reject(err):resolve(b));
    });
    try{
      const zip = await JSZip.loadAsync(blob);
      const entries = Object.values(zip.files);
      for(const entry of entries){
        if(entry.dir) continue;
        if(!/\.(jpg|jpeg|png|gif|webp)$/i.test(entry.name)) continue;
        const ab = await entry.async('arraybuffer');
        const ext = (entry.name.toLowerCase().split('.').pop()||'jpg');
        const imgBlob = new Blob([ab], {type: ext==='jpg' || ext==='jpeg' ? 'image/jpeg' : ('image/'+ext)});
        const url = URL.createObjectURL(imgBlob);
        extractedPhotos.push({name: entry.name.split('/').pop(), url});
        // preview tile
        const img = new Image(); img.src = url; img.className='thumb-sm';
        zipGrid.appendChild(img);
      }
    }catch(e){
      console.error('ZIP extract error', e);
      zipStatus.textContent = 'âŒ Failed to extract a ZIP file.';
    }
  }

  if(extractedPhotos.length){
    zipStatus.textContent = 'âœ… Extracted '+extractedPhotos.length+' photos.';
    saveFromTorrent.style.display = 'inline-block';
  }else{
    zipStatus.textContent = 'âš ï¸ No photos found inside ZIP(s).';
  }
}

function resetTorrentUI(){
  torrentStatus.textContent = '';
  torrentBar.style.width = '0%';
  zipStatus.style.display = 'none';
  zipGrid.innerHTML = '';
  saveFromTorrent.style.display = 'none';
  extractedPhotos = [];
}

saveFromTorrent.onclick = ()=>{
  if(!extractedPhotos.length){ alert('No extracted photos to save.'); return; }
  for(const p of extractedPhotos){
    const id = uid('img');
    state.media[id] = { id, name: p.name, type:'photo', src: p.url, createdAt: Date.now(), folderId:'' };
  }
  save(); renderFolders(); renderMain();
  zipStatus.textContent = 'âœ… Added to Library.';
  saveFromTorrent.style.display = 'none';
};

// ===== Initial render =====
renderFolders(); renderMain();
</script>
</body>
</html>
