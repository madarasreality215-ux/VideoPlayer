<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MediaTracker Pro (Offline) - No Login</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#7c3aed">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="MediaTracker">
<link rel="apple-touch-icon" href="icons/icon-192x192.png">
<style>
  :root{
    --bg-light:#f3f4f6;
    --bg-dark:#0b1220;
    --card-light:#ffffff;
    --card-dark:#0f1724;
    --text-light:#0f1724;
    --text-dark:#e6eef9;
    --accent:#7c3aed;
    --accent-hover:#6d28d9;
    --muted:rgba(230,238,249,0.65);
    --root-folder-color: #10b981;
    --root-folder-hover: #34d399;
    --thumb-size:120px;
    --safe-area: env(safe-area-inset-bottom, 16px);
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial;margin:0;background:var(--bg-dark);color:var(--text-dark);transition:background .2s,color .2s}
  body.light{background:var(--bg-light);color:var(--text-light)}

  /* Header & layout */
  header{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--card-dark);position:sticky;top:0;z-index:100;}
  body.light header{background:var(--card-light)}
  h1{margin:0;font-size:18px}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{background:var(--accent);color:white;padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:600;transition:background .2s}
  .btn:hover{background:var(--accent-hover)}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:inherit;cursor:pointer;transition:background .2s;text-decoration:none;display:flex;align-items:center;gap:4px}
  .ghost:hover{background:rgba(255,255,255,0.05)}
  body.light .ghost{border-color:rgba(0,0,0,0.08)}
  body.light .ghost:hover{background:rgba(0,0,0,0.05)}

  .container{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px;min-height:calc(100vh - 60px)}
  @media (max-width:960px){.container{grid-template-columns:1fr;}}
  @media (max-width:768px){.container{padding:12px;gap:12px;}}
  @media (max-width:480px){.container{padding:8px;gap:8px;}}

  .sidebar{background:var(--card-dark);padding:12px;border-radius:12px;min-height:60vh}
  body.light .sidebar{background:var(--card-light)}
  .main{background:var(--card-dark);padding:12px;border-radius:12px;min-height:60vh}
  body.light .main{background:var(--card-light)}

  .topbar{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  input[type=search]{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
  body.light input[type=search]{border-color:rgba(0,0,0,0.08)}

  .folders{display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow:auto;padding-right:6px}
  .folder{display:flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;transition:background .2s}
  .folder:hover{background:rgba(255,255,255,0.05)}
  .folder .name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .folder .count{font-size:12px;color:var(--muted)}

  .videoList{display:flex;flex-direction:column;gap:8px;max-height:40vh;overflow:auto}
  .vitem{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.02);cursor:pointer;transition:background .2s}
  .vitem:hover{background:rgba(255,255,255,0.05)}
  .vitem.dragging{opacity:0.5;background:rgba(124,58,237,0.2);transform:scale(0.95)}
  .vitem.drop-target{background:rgba(124,58,237,0.1);border:2px dashed var(--accent)}
  .thumb{width:var(--thumb-size);height:calc(var(--thumb-size)*0.6);background:#000;border-radius:8px;overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:#aaa;font-size:12px}
  .thumb img, .thumb video{width:100%;height:100%;object-fit:cover}
  .meta{flex:1;min-width:0}
  .meta h3{margin:0;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .meta p{margin:4px 0 0 0;font-size:12px;color:var(--muted)}
  .fields{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .fields input,.fields textarea,.fields select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px;flex:1;min-width:150px}
  body.light .fields input,body.light .fields textarea,body.light .fields select{border-color:rgba(0,0,0,0.08)}
  .small{font-size:12px;color:var(--muted)}
  .action-section{margin-top:16px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.04)}
  body.light .action-section{background:rgba(0,0,0,0.02);border-color:rgba(0,0,0,0.08)}
  .action-section h3{margin:0 0 8px 0;font-size:14px;color:var(--accent)}
  .action-buttons{display:flex;flex-direction:column;gap:8px}
  .action-buttons .btn,.action-buttons .ghost{width:100%;justify-content:center;text-align:center}

  /* Folder creation */
  .folder-creation {display:flex;flex-direction:column;gap:8px;margin-bottom:16px;}
  .folder-input-row {display:flex;gap:8px;align-items:center;}
  .folder-input-row input {flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px;min-width:0;}
  .folder-select-row {display:flex;gap:8px;align-items:center;}
  .folder-select-row select,
  .url-downloader-btn,
  .file-tools-btn {flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:inherit;font-size:14px;cursor:pointer;min-width:0;transition:background .2s;appearance:none;padding-right:35px;}
  .folder-select-row select:hover,
  .url-downloader-btn:hover,
  .file-tools-btn:hover {background:rgba(255,255,255,0.05)}
  .folder-select-row .btn {white-space:nowrap;flex-shrink:0;}

  /* Upload progress */
  .upload-progress {margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.02); border-radius: 8px; border: 1px solid rgba(255,255,255,0.04)}
  .progress-bar {width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin-top: 8px}
  .progress-fill {height: 100%; background: var(--accent); transition: width 0.3s ease}
  .progress-text {font-size: 12px; color: var(--muted); margin-top: 4px}

  /* Drive-style Fullscreen Viewer */
  .drive-viewer{position:fixed;inset:0;background:linear-gradient(180deg, rgba(8,10,18,.80), rgba(8,10,18,.60));backdrop-filter:blur(3px);display:none;opacity:0;transition:opacity .22s ease;z-index:99999}
  .drive-viewer.show{display:block;opacity:1}
  .drive-topbar{position:absolute;left:0;right:0;top:0;height:56px;display:flex;align-items:center;justify-content:space-between;padding:0 14px;color:#e6eef9;background:linear-gradient(180deg, rgba(0,0,0,.7), rgba(0,0,0,0));border-bottom:1px solid rgba(255,255,255,.07)}
  .drive-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}
  .drive-actions{display:flex;gap:8px}
  .dvbtn{height:32px;padding:0 12px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(255,255,255,.08);color:#fff;cursor:pointer;font-weight:700}
  .dvbtn.danger{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.35)}
  .drive-stage{position:absolute;inset:56px 0 0 0;display:flex;align-items:center;justify-content:center;padding:20px}
  #drivePlayer{width:100%;height:100%;max-height:92vh;max-width:calc(100vw - 40px);background:#000;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.55)}

  /* Mobile */
  @media (max-width:768px){
    .container{min-height:calc(100vh - 120px);margin-bottom:70px}
    .folders, .videoList{max-height:30vh}
    .fields{flex-direction:column}
    .fields input,.fields textarea,.fields select{min-width:auto}
    .thumb{width:80px;height:48px}
    header{padding:10px 12px}
    h1{font-size:16px}
  }
</style>
</head>
<body>
  <header>
    <h1>üì± MediaTracker Pro (Offline)</h1>
    <div class="controls desktop-controls">
      <a href="stats.html" class="ghost">üìä Stats</a>
    </div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <!-- FOLDER CREATION -->
      <div class="folder-creation">
        <div class="folder-input-row">
          <input id="newFolderName" placeholder="New folder name">
        </div>
        <div class="folder-select-row">
          <select id="parentFolderSelect">
            <option value="">üè† Main Library (Home)</option>
          </select>
          <button id="addFolderBtn" class="btn btn-sm">üìÅ Add</button>
        </div>
      </div>

      <div class="folders" id="folders"></div>

      <!-- Add Media Section -->
      <div class="action-section">
        <h3>‚ûï Add Media</h3>
        <div class="action-buttons">
          <label style="display:block">
            <input id="fileInputVideo" type="file" accept="video/*" multiple style="display:none">
            <button id="addVideoBtn" class="btn">üé• Add Videos</button>
          </label>
          <label style="display:block">
            <input id="fileInputPhoto" type="file" accept="image/*" multiple style="display:none">
            <button id="addPhotoBtn" class="btn" style="background:#10b981">üì∑ Add Photos</button>
          </label>
        </div>
        <div class="small" style="text-align:center;margin-top:4px">Supports MP4, WebM, MOV, JPG, PNG, GIF</div>
      </div>

      <!-- Twitter/X Downloader -->
      <div class="action-section">
        <h3>üê¶ Twitter/X Downloader</h3>
        <div class="url-downloader-section">
          <div class="url-input-group">
            <input type="url" id="videoUrl" placeholder="Paste Twitter/X URL here">
          </div>
          <div class="twitter-preview" id="twitterPreview" style="display:none;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.04)">
            <video class="twitter-video-preview" id="twitterVideoPreview" controls style="width:100%;max-width:400px;border-radius:8px;margin-bottom:8px;"></video>
            <div class="twitter-video-info" id="twitterVideoInfo" style="font-size:12px;color:var(--muted);margin-bottom:8px;"></div>
            <div class="twitter-download-options" id="twitterDownloadOptions"></div>
          </div>
          <button class="btn" id="downloadUrlBtn">Fetch Twitter Media</button>
        </div>
      </div>

      <!-- Multi-Platform (Auto-detect) -->
      <div class="action-section">
        <h3>üåê Multi-Platform Downloader</h3>
        <div class="url-downloader-section">
          <div class="url-input-group">
            <input type="url" id="multiPlatformUrl" placeholder="Paste any media URL (YouTube, Instagram, TikTok, etc.)">
          </div>
          <div id="platformInfo" style="display:none; margin:8px 0; padding:8px; background:rgba(124, 58, 237, 0.1); border-radius:8px; display:flex; align-items:center; gap:8px;">
            <span id="platformIcon">üåê</span>
            <span id="platformName" style="font-weight:600">Platform</span>
            <span id="mediaType" style="margin-left:auto;padding:2px 8px;background:var(--accent);color:white;border-radius:12px;font-size:12px;">Media</span>
          </div>
          <div id="multiPlatformPreview" style="display:none;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border:1px solid rgba(255,255,255,0.04)">
            <video id="multiPlatformVideoPreview" controls style="display:none;width:100%;max-width:400px;border-radius:8px;margin-bottom:8px;"></video>
            <img id="multiPlatformImagePreview" style="display:none;max-width:100%;border-radius:8px;margin-bottom:8px;">
            <div id="multiPlatformAudioPreview" style="display:none;text-align:center;padding:20px;">
              <div style="font-size:48px;">üéµ</div>
              <div style="font-size:14px;color:var(--muted);margin-top:8px;">Audio File</div>
            </div>
            <div class="twitter-video-info" id="multiPlatformVideoInfo" style="font-size:12px;color:var(--muted);margin-bottom:8px;"></div>
            <div class="twitter-download-options" id="multiPlatformDownloadOptions"></div>
          </div>
          <div style="display:flex;gap:8px;">
            <button class="btn" id="detectMediaBtn" style="flex:2">üîç Detect Media</button>
            <button class="ghost" id="clearUrlBtn" style="flex:1">Clear</button>
          </div>
          <div class="small" id="apiStatusText" style="margin-top:8px;display:flex;align-items:center;gap:6px;">
            <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#10b981;"></span>
            Ready to detect media
          </div>
        </div>
      </div>

      <!-- Export/Import (local) -->
      <div class="action-section">
        <h3>üì§ Export & Import</h3>
        <div class="action-buttons">
          <button class="btn" id="exportBtn">Export Library</button>
          <button class="ghost" id="importBtn">Import Library</button>
          <input type="file" id="importFileInput" accept=".json" style="display:none">
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <input type="search" id="searchInput" placeholder="üîç Search videos...">
        <button id="sortBtn" class="ghost">üìÖ Sort: Newest</button>
      </div>
      <div class="videoList" id="videoList"></div>
      <div class="viewer" id="viewer" style="display:none"></div>
    </main>
  </div>

  <!-- Drive-style full-screen viewer -->
  <div class="drive-viewer" id="driveViewer" aria-hidden="true">
    <div class="drive-topbar">
      <div class="drive-title" id="driveTitle">Filename</div>
      <div class="drive-actions">
        <a id="downloadOriginal" class="dvbtn" download>‚¨áÔ∏è Download</a>
        <button id="closeDrive" class="dvbtn danger">‚úñ Close</button>
      </div>
    </div>
    <div class="drive-stage">
      <video id="drivePlayer" controls playsinline muted></video>
    </div>
  </div>

<script>
/* =========================
   Offline App State (Local)
   ========================= */
const LS_KEY = 'mediatracker_offline_v1';

let state = {
  folders: [], // {id, name, parentId, created, updated}
  media: {},   // id -> {id, name, type, size, createdAt, folderId, url(objectURL or dataURL), poster(optional)}
  currentFolder: '',
  sortOrder: 'newest'
};

function saveState() {
  try {
    const toSave = {
      ...state,
      // do not persist blob object URLs directly; convert to dataURL for images only if needed
    };
    localStorage.setItem(LS_KEY, JSON.stringify(toSave));
  } catch (e) {
    console.error('Failed to save:', e);
  }
}

function loadState() {
  const raw = localStorage.getItem(LS_KEY);
  if (!raw) return;
  try {
    const parsed = JSON.parse(raw);
    // basic merge
    state.folders = parsed.folders || [];
    state.media = parsed.media || {};
    state.currentFolder = parsed.currentFolder || '';
    state.sortOrder = parsed.sortOrder || 'newest';
  } catch (e) {
    console.warn('Failed to parse saved state:', e);
  }
}

function uid(prefix='id') {
  return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2,9)}`;
}

/* =========================
   DOM Refs
   ========================= */
const foldersEl = document.getElementById('folders');
const videoListEl = document.getElementById('videoList');
const viewerEl = document.getElementById('viewer');

const newFolderNameEl = document.getElementById('newFolderName');
const parentFolderSelectEl = document.getElementById('parentFolderSelect');
const addFolderBtn = document.getElementById('addFolderBtn');

const addVideoBtn = document.getElementById('addVideoBtn');
const addPhotoBtn = document.getElementById('addPhotoBtn');
const fileInputVideo = document.getElementById('fileInputVideo');
const fileInputPhoto = document.getElementById('fileInputPhoto');

const searchInput = document.getElementById('searchInput');
const sortBtn = document.getElementById('sortBtn');

// Downloader refs
const videoUrlEl = document.getElementById('videoUrl');
const downloadUrlBtn = document.getElementById('downloadUrlBtn');
const twitterPreviewEl = document.getElementById('twitterPreview');
const twitterVideoPreview = document.getElementById('twitterVideoPreview');
const twitterVideoInfo = document.getElementById('twitterVideoInfo');
const twitterDownloadOptions = document.getElementById('twitterDownloadOptions');

const multiUrlEl = document.getElementById('multiPlatformUrl');
const detectMediaBtn = document.getElementById('detectMediaBtn');
const clearUrlBtn = document.getElementById('clearUrlBtn');
const platformInfo = document.getElementById('platformInfo');
const platformIcon = document.getElementById('platformIcon');
const platformName = document.getElementById('platformName');
const mediaTypeBadge = document.getElementById('mediaType');
const multiPreview = document.getElementById('multiPlatformPreview');
const mpVideo = document.getElementById('multiPlatformVideoPreview');
const mpImage = document.getElementById('multiPlatformImagePreview');
const mpAudio = document.getElementById('multiPlatformAudioPreview');
const mpInfo = document.getElementById('multiPlatformVideoInfo');
const mpOptions = document.getElementById('multiPlatformDownloadOptions');

// Export/Import
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const importFileInput = document.getElementById('importFileInput');

// Drive viewer
const driveViewer = document.getElementById('driveViewer');
const drivePlayer = document.getElementById('drivePlayer');
const driveTitle = document.getElementById('driveTitle');
const closeDrive = document.getElementById('closeDrive');
const downloadOriginal = document.getElementById('downloadOriginal');

/* =========================
   Initialization
   ========================= */
loadState();
renderAll();

/* =========================
   Folder Management
   ========================= */
function renderFolders() {
  // parent select
  parentFolderSelectEl.innerHTML = '<option value="">üè† Main Library (Home)</option>';
  state.folders.forEach(f => {
    const opt = document.createElement('option');
    opt.value = f.id;
    opt.textContent = f.name;
    parentFolderSelectEl.appendChild(opt);
  });

  // list
  foldersEl.innerHTML = '';
  const rootBtn = document.createElement('div');
  rootBtn.className = 'folder' + (state.currentFolder === '' ? ' active' : '');
  rootBtn.innerHTML = '<span>üè†</span><div class="name">Main Library</div>';
  rootBtn.onclick = () => { state.currentFolder = ''; renderAll(); saveState(); };
  foldersEl.appendChild(rootBtn);

  state.folders.forEach(f => {
    const el = document.createElement('div');
    el.className = 'folder' + (state.currentFolder === f.id ? ' active' : '');
    el.innerHTML = `<span>üìÅ</span><div class="name">${f.name}</div><div class="count">${countInFolder(f.id)}</div>`;
    el.onclick = () => { state.currentFolder = f.id; renderAll(); saveState(); };
    foldersEl.appendChild(el);
  });
}

function countInFolder(folderId) {
  return Object.values(state.media).filter(m => (m.folderId || '') === folderId).length;
}

addFolderBtn.addEventListener('click', () => {
  const name = (newFolderNameEl.value || '').trim();
  const parentId = parentFolderSelectEl.value || '';
  if (!name) return;
  const id = uid('folder');
  const folder = { id, name, parentId, created: Date.now(), updated: Date.now() };
  state.folders.push(folder);
  newFolderNameEl.value = '';
  renderFolders();
  saveState();
});

/* =========================
   Media Rendering
   ========================= */
function renderList() {
  const term = (searchInput.value || '').toLowerCase();
  const items = Object.values(state.media).filter(m => {
    const inFolder = (m.folderId || '') === (state.currentFolder || '');
    const matches = !term || (m.name || '').toLowerCase().includes(term);
    return inFolder && matches;
  }).sort((a,b) => state.sortOrder === 'newest' ? (b.createdAt - a.createdAt) : (a.createdAt - b.createdAt));

  videoListEl.innerHTML = '';
  items.forEach(item => {
    const el = document.createElement('div');
    el.className = 'vitem';
    el.draggable = true;

    const thumb = document.createElement('div');
    thumb.className = 'thumb';
    if (item.type.startsWith('image/')) {
      const img = document.createElement('img');
      img.src = item.url;
      thumb.appendChild(img);
    } else if (item.type.startsWith('video/')) {
      const v = document.createElement('video');
      v.src = item.url;
      v.muted = true;
      v.playsInline = true;
      thumb.appendChild(v);
    } else {
      thumb.textContent = 'FILE';
    }

    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `<h3>${item.name}</h3><p>${(item.type||'file')} ‚Ä¢ ${formatSize(item.size)}</p>`;

    const openBtn = document.createElement('button');
    openBtn.className = 'ghost';
    openBtn.textContent = '‚ñ∂ Open';
    openBtn.onclick = (e) => { e.stopPropagation(); openInDrive(item); };

    const moveBtn = document.createElement('button');
    moveBtn.className = 'ghost';
    moveBtn.textContent = '‚Üó Move';
    moveBtn.onclick = (e) => { e.stopPropagation(); movePrompt(item); };

    const delBtn = document.createElement('button');
    delBtn.className = 'ghost';
    delBtn.textContent = 'üóë Delete';
    delBtn.onclick = (e) => { e.stopPropagation(); deleteItem(item); };

    el.appendChild(thumb);
    el.appendChild(meta);
    el.appendChild(openBtn);
    el.appendChild(moveBtn);
    el.appendChild(delBtn);

    // drag helpers
    el.addEventListener('dragstart', () => {
      el.classList.add('dragging');
      el.dataset.dragId = item.id;
    });
    el.addEventListener('dragend', () => {
      el.classList.remove('dragging');
      el.removeAttribute('data-drag-id');
    });

    videoListEl.appendChild(el);
  });

  // allow dropping onto folder list
  Array.from(foldersEl.children).forEach(folderNode => {
    if (!folderNode.classList.contains('folder')) return;
    folderNode.addEventListener('dragover', (e) => e.preventDefault());
    folderNode.addEventListener('drop', (e) => {
      e.preventDefault();
      const dragItem = document.querySelector('.vitem.dragging');
      if (!dragItem) return;
      const id = dragItem.dataset.dragId;
      const folderName = folderNode.querySelector('.name')?.textContent || 'Main Library';
      const targetId = folderName === 'Main Library' ? '' : findFolderIdByName(folderName);
      if (id in state.media) {
        state.media[id].folderId = targetId || '';
        saveState(); renderAll();
      }
    });
  });
}

function findFolderIdByName(name){
  const f = state.folders.find(x => x.name === name);
  return f?.id || '';
}

function openInDrive(item) {
  driveTitle.textContent = item.name;
  drivePlayer.src = item.url;
  drivePlayer.currentTime = 0;
  drivePlayer.muted = true;
  downloadOriginal.href = item.url;
  downloadOriginal.download = item.name;
  driveViewer.classList.add('show');
  driveViewer.setAttribute('aria-hidden','false');
}

closeDrive.addEventListener('click', () => {
  drivePlayer.pause();
  driveViewer.classList.remove('show');
  driveViewer.setAttribute('aria-hidden','true');
  setTimeout(()=>{ drivePlayer.src=''; }, 200);
});

function movePrompt(item) {
  const name = prompt('Move to folder (leave blank for Main Library):', '');
  if (name === null) return;
  const id = name ? findFolderIdByName(name) : '';
  state.media[item.id].folderId = id || '';
  saveState(); renderAll();
}

function deleteItem(item) {
  if (!confirm(`Delete "${item.name}"? This cannot be undone.`)) return;
  URL.revokeObjectURL?.(item.url);
  delete state.media[item.id];
  saveState(); renderAll();
}

/* =========================
   Uploads
   ========================= */
addVideoBtn.addEventListener('click', () => fileInputVideo.click());
addPhotoBtn.addEventListener('click', () => fileInputPhoto.click());

fileInputVideo.addEventListener('change', (e) => handleFiles(e.target.files, 'video'));
fileInputPhoto.addEventListener('change', (e) => handleFiles(e.target.files, 'image'));

function handleFiles(fileList, mode) {
  if (!fileList || !fileList.length) return;
  Array.from(fileList).forEach(file => {
    const id = uid('media');
    const url = URL.createObjectURL(file);
    const item = {
      id, name: file.name, type: file.type || (mode === 'video' ? 'video/*' : 'image/*'),
      size: file.size || 0, createdAt: Date.now(), folderId: state.currentFolder || '', url
    };
    // show progress UI simulation
    simulateProgress(file, () => {
      state.media[id] = item;
      saveState(); renderAll();
    });
  });
}

function simulateProgress(file, doneCb) {
  // duration ~2‚Äì10s depending on size (<=5MB -> 2s, >=200MB -> 10s)
  const mb = file.size / (1024*1024);
  const min = 2, max = 10;
  const dur = Math.max(min, Math.min(max, Math.round((mb/200)*(max-min)+min))); // coarse map
  const box = document.createElement('div');
  box.className = 'upload-progress';
  box.innerHTML = `<div>${file.name}</div>
    <div class="progress-bar"><div class="progress-fill" style="width:0%"></div></div>
    <div class="progress-text">0%</div>`;
  viewerEl.style.display = 'block';
  viewerEl.innerHTML = '';
  viewerEl.appendChild(box);

  const fill = box.querySelector('.progress-fill');
  const text = box.querySelector('.progress-text');
  let p = 0;
  const step = 100 / (dur*5); // 5 updates per second
  const iv = setInterval(() => {
    p = Math.min(100, p + step);
    fill.style.width = p.toFixed(0) + '%';
    text.textContent = p.toFixed(0) + '%';
    if (p >= 100) {
      clearInterval(iv);
      setTimeout(() => {
        // keep at 100% for ~1s then hide
        viewerEl.style.display = 'none';
        viewerEl.innerHTML = '';
        doneCb();
      }, 1000);
    }
  }, 200);
}

function formatSize(bytes) {
  if (!bytes) return '‚Äî';
  const sizes = ['B','KB','MB','GB','TB'];
  const i = Math.floor(Math.log(bytes)/Math.log(1024));
  return (bytes/Math.pow(1024,i)).toFixed(1)+' '+sizes[i];
}

/* =========================
   Search / Sort
   ========================= */
searchInput.addEventListener('input', renderList);
sortBtn.addEventListener('click', () => {
  state.sortOrder = state.sortOrder === 'newest' ? 'oldest' : 'newest';
  sortBtn.textContent = state.sortOrder === 'newest' ? 'üìÖ Sort: Newest' : 'üìÖ Sort: Oldest';
  saveState(); renderList();
});

/* =========================
   Simple URL Detection
   ========================= */
const PLATFORM_PATTERNS = {
  youtube: { patterns: [/(?:youtube\.com\/.*[?&]v=|youtu\.be\/)([^"&?\/\s]{11})/], name:'YouTube', icon:'üì∫', type:'video' },
  instagram: { patterns: [/instagram\.com\/(?:p|reel|stories)\/([^\/?]+)/], name:'Instagram', icon:'üì∑', type:'mixed' },
  tiktok: { patterns: [/tiktok\.com\/@[\w.]+\/video\/(\d+)/], name:'TikTok', icon:'üéµ', type:'video' },
  vimeo: { patterns: [/vimeo\.com\/(\d+)/], name:'Vimeo', icon:'üé•', type:'video' },
  twitter: { patterns: [/(?:twitter\.com|x\.com)\/\w+\/status\/(\d+)/], name:'Twitter/X', icon:'üê¶', type:'mixed' }
};

function detectPlatform(url) {
  for (const key of Object.keys(PLATFORM_PATTERNS)) {
    const {patterns, name, icon, type} = PLATFORM_PATTERNS[key];
    for (const re of patterns) {
      const m = url.match(re);
      if (m) return {key, name, icon, type, id: m[1]};
    }
  }
  return null;
}

downloadUrlBtn.addEventListener('click', () => {
  const url = (videoUrlEl.value||'').trim();
  if (!url) return;
  const det = detectPlatform(url);
  twitterPreviewEl.style.display = 'block';
  twitterVideoInfo.textContent = det ? `${det.icon} ${det.name} post detected (ID: ${det.id}).` : 'URL parsed. If this is a direct MP4 link it will preview below.';

  // If it looks like direct media, preview it
  if (/\.(mp4|webm|mov)(\?|#|$)/i.test(url)) {
    twitterVideoPreview.src = url;
    twitterVideoPreview.style.display = 'block';
  } else {
    twitterVideoPreview.removeAttribute('src');
    twitterVideoPreview.style.display = 'none';
  }

  twitterDownloadOptions.innerHTML = '';
  const btn = document.createElement('button');
  btn.className = 'btn';
  btn.textContent = '‚¨áÔ∏è Add to Video List';
  btn.onclick = () => {
    // We cannot actually fetch remote video without a CORS-enabled API;
    // so we just save the URL record into the list (stream-only).
    const id = uid('media');
    const name = `Link - ${det?.name || 'Media'}`;
    const item = { id, name, type: 'video/url', size: 0, createdAt: Date.now(), folderId: state.currentFolder || '', url };
    state.media[id] = item;
    saveState(); renderAll();
    alert('Added link to your Video List. Note: playback depends on CORS/host.');
  };
  twitterDownloadOptions.appendChild(btn);
});

detectMediaBtn.addEventListener('click', () => {
  const url = (multiUrlEl.value||'').trim();
  if (!url) return;
  const det = detectPlatform(url) || {name:'Unknown', icon:'üåê', type:'mixed'};
  platformInfo.style.display = 'flex';
  platformIcon.textContent = det.icon;
  platformName.textContent = det.name;
  mediaTypeBadge.textContent = det.type.toUpperCase();

  mpVideo.style.display = 'none';
  mpImage.style.display = 'none';
  mpAudio.style.display = 'none';
  multiPreview.style.display = 'block';

  if (/\.(mp4|webm|mov)(\?|#|$)/i.test(url)) {
    mpVideo.src = url; mpVideo.style.display = 'block'; mpInfo.textContent = 'Direct video link detected.';
  } else if (/\.(png|jpg|jpeg|gif|webp)(\?|#|$)/i.test(url)) {
    mpImage.src = url; mpImage.style.display = 'block'; mpInfo.textContent = 'Direct image link detected.';
  } else if (/\.(mp3|wav|ogg|m4a)(\?|#|$)/i.test(url)) {
    mpAudio.style.display = 'block'; mpInfo.textContent = 'Direct audio link detected.';
  } else {
    mpInfo.textContent = 'Embedded platform link detected. Add as a link item (playback depends on host).';
  }

  mpOptions.innerHTML = '';
  const addBtn = document.createElement('button');
  addBtn.className = 'btn';
  addBtn.textContent = '‚¨áÔ∏è Add to Video List';
  addBtn.onclick = () => {
    const id = uid('media');
    const name = `Link - ${det.name}`;
    const item = { id, name, type: (mpVideo.style.display==='block'?'video/url': (mpImage.style.display==='block'?'image/url':'link')), size:0, createdAt:Date.now(), folderId: state.currentFolder || '', url };
    state.media[id] = item;
    saveState(); renderAll();
    alert('Added link to your Video List.');
  };
  mpOptions.appendChild(addBtn);
});

clearUrlBtn.addEventListener('click', () => {
  multiUrlEl.value = '';
  platformInfo.style.display = 'none';
  multiPreview.style.display = 'none';
  mpVideo.removeAttribute('src'); mpImage.removeAttribute('src');
});

/* =========================
   Export / Import
   ========================= */
exportBtn.addEventListener('click', () => {
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `mediatracker-export-${Date.now()}.json`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
});

importBtn.addEventListener('click', () => importFileInput.click());
importFileInput.addEventListener('change', async (e) => {
  const file = e.target.files?.[0];
  if (!file) return;
  try {
    const text = await file.text();
    const json = JSON.parse(text);
    if (!json || !json.media || !json.folders) throw new Error('Invalid export file');
    state = json;
    saveState(); renderAll();
    alert('Library imported!');
  } catch (err) {
    alert('Failed to import: ' + err.message);
  } finally {
    importFileInput.value = '';
  }
});

/* =========================
   Render Root
   ========================= */
function renderAll() {
  renderFolders();
  renderList();
  sortBtn.textContent = state.sortOrder === 'newest' ? 'üìÖ Sort: Newest' : 'üìÖ Sort: Oldest';
}
</script>
</body>
</html>
