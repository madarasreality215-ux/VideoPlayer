<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Oathbound Archives — Login</title>

<!-- Fonts (optional aesthetic) -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">

<style>
/* === Oathbound Archives – Cinematic Login (Standalone) === */

/* Background mural (ONLY this gets blurred) */
.background-layer {
  position: fixed;
  inset: 0;
  background: url("https://i.postimg.cc/wjqh586L/The-fool.jpg") center/cover no-repeat;
  filter: brightness(0.35) contrast(1.05) blur(4px);
  opacity: 0.45;
  z-index: -3;
}

/* Visualizer canvas (centered, light blur for glow) */
#visualizer {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: -2;
  display: block;
  pointer-events: none;
  opacity: 1;
  filter: blur(1.2px);
  transition: opacity .6s ease;
}

/* Stone login card */
.card-auth {
  background: #2a2a2e !important;
  border: 1px solid rgba(200,200,210,0.20);
  box-shadow: 0 0 20px rgba(255,255,255,0.05), inset 0 0 12px rgba(255,255,255,0.08);
  border-radius: 14px;
  padding: 24px 30px;
  position: relative;
  z-index: 10;
  color: #e8e8ea;
  max-width: 420px;
  margin: 10vh auto 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji';
}

/* Inputs / buttons */
.card-auth input, .card-auth button {
  width: 100%;
  box-sizing: border-box;
  margin-top: 10px;
  padding: 12px 14px;
  border-radius: 10px;
  border: 1px solid rgba(200,200,210,0.25);
  background: #212126;
  color: #f2f3f7;
  outline: none;
  transition: box-shadow 200ms ease, transform 200ms ease, background 200ms ease;
}
.card-auth input::placeholder { color: #aeb0b7; }
.card-auth input:focus, .card-auth button:hover {
  box-shadow: 0 0 16px rgba(210,210,220,0.35), 0 0 2px rgba(255,255,255,0.15);
  transform: translateY(-1px);
}
.card-auth button {
  background: #3b3f4d;
  cursor: pointer;
  font-weight: 600;
}

/* Awaken overlay */
#awakenOverlay {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(10,9,8,0.92);
  z-index: 999999 !important; /* ensure overlay above all */
  cursor: pointer;
  opacity: 1;
  pointer-events: all !important;
  transition: opacity 900ms ease;
}
#awakenOverlay.hidden {
  opacity: 0;
  pointer-events: none;
}
#awakenOverlay .awaken-text{
  font-family: "Cinzel", Georgia, serif;
  font-size: 28px;
  letter-spacing: 1px;
  color: #d9d2c2;
  text-shadow: 0 0 6px rgba(255, 214, 140, 0.45), 0 0 18px rgba(255, 194, 100, 0.25), 0 0 36px rgba(255, 170, 60, 0.15);
  padding: 18px 26px;
  border: 1px solid rgba(200,190,170,0.25);
  border-radius: 10px;
  background: radial-gradient(ellipse at center, rgba(40,36,30,0.35), rgba(24,22,20,0.15) 60%, rgba(0,0,0,0));
}

/* Oath Accepted overlay */
#oathAcceptedOverlay {
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.6); z-index:9999;
}
#oathAcceptedOverlay .crest {
  text-align:center; color:#e8e6ff; font-family:Georgia,serif; letter-spacing:1px;
  padding:28px 36px; border:2px solid rgba(200,200,210,0.35); border-radius:16px;
  box-shadow:0 0 30px rgba(200,200,210,0.25), inset 0 0 20px rgba(210,210,220,0.18);
  background: radial-gradient(ellipse at center, rgba(23,27,40,0.95), rgba(10,12,18,0.95));
}
#oathAcceptedOverlay h2 { margin:0 0 8px 0; font-size:26px; color:#e6e9f5; }

/* Responsive */
@media (max-width: 600px) {
  .card-auth { margin-top: 8vh; padding: 18px 20px; border-radius: 12px; }
  #awakenOverlay .awaken-text { font-size: 22px; padding: 14px 18px; }
}
</style>
</head>
<body>

<div class="background-layer"></div>

<div id="awakenOverlay"><div class="awaken-text">Click to Awaken the Archive</div></div>

<div id="oathAcceptedOverlay">
  <div class="crest">
    <h2>Oath Bound – Access Granted</h2>
    <p style="margin:0;opacity:0.9;">Welcome to the Oathbound Archives</p>
  </div>
</div>

<!-- Centered visualizer -->
<canvas id="visualizer"></canvas>

<!-- Login Card (Firebase-auth form placeholder) -->
<div class="card-auth">
  <h1 style="margin:0 0 8px 0;">Oathbound Archives</h1>
  <p class="subtitle" style="margin:0 0 14px 0; opacity:.85;">Enter the Royal Gateway</p>

  <label for="email">Scroll of Identity</label>
  <input id="email" type="email" placeholder="Scroll of Identity" autocomplete="username"/>

  <label for="password" style="margin-top:10px;">Sigil Key</label>
  <input id="password" type="password" placeholder="Sigil Key" autocomplete="current-password"/>

  <button id="loginBtn" style="margin-top:12px;">Swear Thy Oath</button>
  <div id="loginMsg" style="margin-top:10px; font-size: 0.9rem; opacity:.85;"></div>
</div>

<!-- Firebase SDKs (assumes your config is included globally or via your existing setup) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
// IMPORTANT: If your Firebase config isn't globally injected, paste it here:
/*
var firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "...", appId: "..." };
firebase.initializeApp(firebaseConfig);
*/

// Canvas setup
const canvas = document.getElementById("visualizer");
const ctx = canvas.getContext("2d");
function fitCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
fitCanvas(); window.addEventListener("resize", fitCanvas);

// Media
const AUDIO_SRC = "golden_brown_vibes.mp3"; // keep in repo root
const audio = new Audio(AUDIO_SRC);
audio.loop = true;
audio.crossOrigin = "anonymous";
audio.volume = 0;

let audioCtx;
try { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
let analyser, dataArray, source;
if (audioCtx){
  try{
    source = audioCtx.createMediaElementSource(audio);
    analyser = new AnalyserNode(audioCtx, { fftSize: 1024 });
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }catch(e){}
}

// State & helpers
let running=false, targetVolume=0.75, fadeInt=null;
function fadeAudio(toVol, dur=1500){
  if(!audio) return;
  clearInterval(fadeInt);
  const steps=30, dt=dur/steps, diff=toVol-audio.volume;
  let i=0; fadeInt=setInterval(()=>{
    i++; audio.volume += diff/steps;
    if(i>=steps){ audio.volume = toVol; clearInterval(fadeInt); if(toVol===0){ try{ audio.pause(); }catch(_){} } }
  }, dt);
}

class Particle{ constructor(x,y,s,c,d){ this.x=x; this.y=y; this.size=s; this.color=c; this.depth=d; this.alpha=1; this.sy=Math.random()*-1.2-0.3; }
  update(){ this.y+=this.sy; this.x+=Math.sin(this.y*0.01)*this.depth*0.25; this.alpha-=0.015; }
  draw(){ ctx.globalAlpha=this.alpha; ctx.fillStyle=this.color; ctx.shadowBlur=8; ctx.shadowColor=this.color; ctx.beginPath(); ctx.arc(this.x,this.y,this.size,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1; } }
const particles=[];
function spawnParticles(energy){ const mobile=canvas.width<600; const base=energy>150?(mobile?2:4):energy>110?(mobile?1:2):1;
  for(let i=0;i<base;i++){ const x=Math.random()*canvas.width, y=canvas.height*0.45+Math.sin(Math.random()*Math.PI)*40;
    const s=Math.random()*3+1.2, d=Math.random()*1.5+0.5; const c=Math.random()<0.6?'rgba(220,220,220,0.9)':'rgba(180,180,180,0.85)';
    particles.push(new Particle(x,y,s,c,d)); } }

const runes=['ᚠ','ᚢ','ᚦ','ᚨ','ᚱ','ᚲ','ᚷ','ᚺ','ᚾ','ᛁ','ᛃ','ᛇ','ᛈ','ᛉ','ᛊ','ᛏ','ᛒ','ᛗ','ᛚ','ᛜ','ᛟ','ᛞ'];
const runeSigils=Array.from({length:8}).map((_,i)=>({ angle:(Math.PI*2/8)*i, radius:110+Math.random()*28, rot:(Math.random()*0.5+0.15)*(Math.random()<0.5?-1:1), glyph:runes[Math.floor(Math.random()*runes.length)] }));
function drawRunes(t){ const authCard=document.querySelector('.card-auth'); if(!authCard) return;
  const rect=authCard.getBoundingClientRect(), cx=rect.left+rect.width/2, cy=rect.top+rect.height/2;
  ctx.save(); ctx.font='18px Georgia'; ctx.textAlign='center'; ctx.textBaseline='middle';
  for(const s of runeSigils){ const a=s.angle+t*0.004*s.rot, x=cx+Math.cos(a)*s.radius, y=cy+Math.sin(a)*s.radius; const alpha=0.18+0.2*Math.sin(t*0.018+s.angle);
    ctx.globalAlpha=alpha; ctx.fillStyle='rgba(230,230,230,0.95)'; ctx.fillText(s.glyph,x,y); } ctx.restore(); ctx.globalAlpha=1; }

class Spirit{ constructor(){ const w=canvas.width,h=canvas.height; this.p0={x:-60,y:Math.random()*h*0.8+h*0.1}; this.p1={x:Math.random()*w*0.5,y:Math.random()*h};
  this.p2={x:Math.random()*w*0.5+w*0.5,y:Math.random()*h}; this.p3={x:w+60,y:Math.random()*h*0.8+h*0.1}; this.t=0; this.speed=0.002+Math.random()*0.0025; this.size=3+Math.random()*3; this.color='rgba(235,235,235,0.7)'; }
  step(){ this.t+=this.speed; if(this.t>1) this.t=1; }
  pos(){ const t=this.t,mt=1-t; return { x:mt*mt*mt*this.p0.x+3*mt*mt*t*this.p1.x+3*mt*t*t	this.p2.x+t*t*t	this.p3.x,
    y:mt*mt*mt	this.p0.y+3*mt*mt*t	this.p1.y+3*mt*t*t	this.p2.y+t*t*t	this.p3.y }; }
  draw(){ const p=this.pos(); ctx.save(); ctx.globalAlpha=0.6*(1-Math.abs(this.t-0.5)*1.5); ctx.fillStyle=this.color; ctx.shadowBlur=16; ctx.shadowColor	this.color;
    ctx.beginPath(); ctx.arc(p.x,p.y,this.size,0,Math.PI*2); ctx.fill(); ctx.restore(); } }
let spirits=[], spiritCooldown=0;

// Background painter
function paintBackground(){
  const g=ctx.createLinearGradient(0,0,0,canvas.height); g.addColorStop(0,'#1a1a1d'); g.addColorStop(1,'#2b2b30');
  ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);
  const r=ctx.createRadialGradient(canvas.width*.5,canvas.height*.35,50,canvas.width*.5,canvas.height*.35,Math.max(canvas.width,canvas.height)*.7);
  r.addColorStop(0,'rgba(255,255,255,0.06)'); r.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=r; ctx.fillRect(0,0,canvas.width,canvas.height);
}

// Waves
function drawSteelWave(energy,t,layer=1){
  const mid=canvas.height/2, amp=30+(energy/255)*55*layer, wl=160/layer, sp=0.012;
  const grad=ctx.createLinearGradient(0,0,canvas.width,0); grad.addColorStop(0,'#888'); grad.addColorStop(0.5,'#bcbcbc'); grad.addColorStop(1,'#d9d9d9');
  ctx.lineWidth=2.4/layer; ctx.strokeStyle=grad; ctx.shadowBlur=20/layer; ctx.shadowColor='#cfcfcf';
  ctx.beginPath(); for(let x=0;x<canvas.width;x+=6){ const y=mid+Math.sin(x/wl+t*sp*layer)*amp*0.8; ctx.lineTo(x,y); } ctx.stroke();
}

// Loop
let tick=0;
function animate(){
  if(!running) return; requestAnimationFrame(animate);
  let energy=0; if(analyser&&dataArray){ analyser.getByteFrequencyData(dataArray); energy=dataArray.reduce((a,b)=>a+b,0)/dataArray.length; }
  paintBackground(); drawSteelWave(energy,tick,1.0); drawSteelWave(energy,tick,1.3);
  spawnParticles(energy); for(const p of particles){ p.update(); p.draw(); } for(let i=particles.length-1;i>=0;i--) if(particles[i].alpha<=0) particles.splice(i,1);
  if(cursor.active){ for(const p of particles){ const dx=cursor.x-p.x, dy=cursor.y-p.y, d2=dx*dx+dy*dy; if(d2<120*120){ p.x+=dx*0.003; p.y+=dy*0.003; } }
    if(Math.random()<0.25) particles.push(new Particle(cursor.x,cursor.y,Math.random()*2+1,'rgba(210,210,210,0.9)',1)); }
  if(spiritCooldown<=0 && Math.random()<0.01){ spirits.push(new Spirit()); spiritCooldown=600; } else { spiritCooldown--; }
  for(let i=spirits.length-1;i>=0;i--){ const s=spirits[i]; s.step(); s.draw(); if(s.t>=1) spirits.splice(i,1); }
  drawRunes(tick); tick++;
}

// Cursor
let cursor={x:window.innerWidth/2,y:window.innerHeight/2,active:false};
window.addEventListener('mousemove',e=>{cursor.x=e.clientX;cursor.y=e.clientY;cursor.active=true;});
window.addEventListener('mouseleave',()=>{cursor.active=false;});

// Controls
function showVisualizer(){ running=true; canvas.style.opacity='1'; animate(); }
function hideVisualizer(){ running=false; canvas.style.opacity='0'; fadeAudio(0,1500); }
function showOathAccepted(){ const el=document.getElementById('oathAcceptedOverlay'); if(!el) return; el.style.display='flex'; setTimeout(()=>{el.style.display='none';},1500); }

// Awaken overlay (starts audio + visuals)
const awakenEl=document.getElementById('awakenOverlay');
if(awakenEl){
  awakenEl.addEventListener('click', async ()=>{
    awakenEl.classList.add('hidden');
    try{ if(audioCtx){ await audioCtx.resume(); await audio.play(); fadeAudio(targetVolume,1500); } }catch(e){}
    showVisualizer();
  });
}

// Login button handler (email/password)
const emailEl = document.getElementById('email');
const passEl  = document.getElementById('password');
const btnEl   = document.getElementById('loginBtn');
const msgEl   = document.getElementById('loginMsg');

if (btnEl) {
  btnEl.addEventListener('click', async () => {
    if (!window.firebase || !firebase.auth) { msgEl.textContent = "Firebase not loaded."; return; }
    const email = (emailEl && emailEl.value) || "";
    const pass  = (passEl && passEl.value)  || "";
    try {
      await firebase.auth().signInWithEmailAndPassword(email, pass);
      // Success handled by auth listener below
    } catch (err) {
      msgEl.textContent = err && err.message ? err.message : "Login failed.";
    }
  });
}

// Firebase auth listener: if logged in, show overlay, fade out audio, hide visualizer instantly, then redirect
if (window.firebase && firebase.auth) {
  firebase.auth().onAuthStateChanged((u) => {
    const bg = document.querySelector('.background-layer');
    if (u) {
      // Logged in -> prepare solid bg, stop audio/visuals, show overlay, then redirect
      if (bg) { bg.style.background = '#0B1220'; bg.style.filter = 'none'; bg.style.opacity = '1'; }
      try { document.getElementById('visualizer').style.display = 'none'; } catch(_) {}
      fadeAudio(0, 1500); hideVisualizer(); showOathAccepted();
      setTimeout(function(){ window.location.href = 'index.html'; }, 1500);
    } else {
      // Logged out -> ensure mural present
      if (bg) {
        bg.style.background = 'url("https://i.postimg.cc/wjqh586L/The-fool.jpg") center/cover no-repeat';
        bg.style.filter = 'brightness(0.35) contrast(1.05) blur(4px)';
        bg.style.opacity = '0.45';
      }
      if (awakenEl) awakenEl.classList.remove('hidden');
    }
  });
}
</script>
</body>
</html>
